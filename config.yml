# Video2Subtitle 配置文件
# -----------------------------------
# 在运行 run_pipeline.py 时，可以通过 --config config.yml 参数来加载此文件中的配置。

# 1. 解码器模块配置
decoder:
  # GPU解码时，一次性送入显存的帧数。更大的值可以加快解码速度，但会增加显存占用。
  # 建议值: 16, 32, 64
  batch_size: 32

# 2. 字幕区域检测模块配置
area_detector:
  # 为了确定字幕区域，从整个视频中均匀采样的帧数。值越大，区域定位越准，但检测耗时越长。
  # 建议值: 100 ~ 500
  sample_count: 300
  # 在采样帧中，被认为是有效文本的最小字符长度。用于计算权重，避免将单个噪点字符计入范围。
  # 建议值: 2, 3
  min_text_len: 2
  # 用于并行分析视频帧以确定字幕位置的工作进程数。
  # 默认值: min(CPU核心数, 4)
  # 增加此值可以加快区域检测速度，但会消耗更多CPU和内存。
  num_workers: 4
  # 检测到的字幕区域上下各扩展的像素数，用于确保完整捕获字幕内容。
  # 建议值: 5-10 (精确字幕), 10-15 (一般场景), 15-30 (有特效字幕)
  # 默认值: 10
  y_padding: 10

# 3. 关键帧检测模块配置 (新架构)
keyframe_detector:
  # 感知哈希(dHash)的大小。更高的值可以更精确地捕捉图像内容的细节，但也可能对微小噪点更敏感。
  # 推荐值: 8, 16
  dhash_size: 8
  # 相似度阈值。两帧间相似度低于此值则认为是新的关键帧。基于Dr. Neal Krawetz的行业标准设定。
  # - 90% (0.90): 严格模式，只有显著差异才触发新关键帧，适合内容变化明显的字幕
  # - 85% (0.85): 平衡模式，适合大多数场景
  # - 80% (0.80): 宽松模式，对细微变化也敏感，适合动画或特效字幕
  # 建议值: 0.90
  similarity_threshold: 0.90

# 4. OCR识别模块配置
ocr:
  # 当使用本地 PaddleOCR 实例时 (即 ocr_server.enabled = false)，此语言设置生效。
  # 当使用 ocr_server 时，语言模型在服务器端配置，此处设置被忽略。
  lang: 'ch' # 英文en 中文ch
  num_workers: 4
  
  # PaddleOCR 3.x 核心参数配置 (基于测试结果优化)
  # 测试证明：PP-OCRv5 + 英文 + 以下参数 = 99.96%置信度
  paddleocr_config:
    # 模型版本选择 - PP-OCRv5是最新最准确的版本
    ocr_version: 'PP-OCRv5'
    
    # 文本检测参数 (针对字幕条优化)
    text_det_limit_side_len: 64         # 降低最小边长限制，适应字幕条高度. 必须要有, 如果注释掉就会报`Resized image size`错误
    text_det_thresh: 0.30               # 文本检测像素阈值 (在线成功参数)
    text_det_box_thresh: 0.60           # 文本检测框阈值 (在线成功参数)  
    text_det_unclip_ratio: 1.50         # 文本检测扩张系数 (在线成功参数，之前2.0太大)
    text_det_input_shape: null          # 检测模型输入形状，null使用默认
    
    # 文本识别参数
    text_recognition_batch_size: 8  # 识别批处理大小
    text_rec_score_thresh: 0        # 文本识别阈值 (在线成功参数)
    text_rec_input_shape: null      # 识别模型输入形状，null使用默认
    
    # 方向分类参数 (字幕场景优化：全部关闭以提高速度)
    use_doc_orientation_classify: false    # 关闭文档图像方向分类
    use_doc_unwarping: false              # 关闭文档扭曲矫正
    use_textline_orientation: false       # 关闭文本行方向分类
    textline_orientation_batch_size: 6    # 方向分类批处理大小
    
    # 其他优化参数
    return_word_box: false          # 是否返回单词级别的边界框
    precision: "fp32"              # 推理精度：fp32(精度高) 或 fp16(速度快)
    use_tensorrt: false            # 是否启用TensorRT加速 (需要支持)
  
  # 模型配置 - 用于字幕场景的最佳模型选择
  models:
    # 文本检测模型 - 检测文本区域
    detection_model: "PP-OCRv5_server_det"
    
    # 文本识别模型配置 - 按语言优化选择
    recognition_models:
      zh: "PP-OCRv5_server_rec"           # 中文简体 (最佳)
      chinese_cht: "PP-OCRv5_server_rec"  # 中文繁体
      en: "en_PP-OCRv5_mobile_rec"        # 英文专用 (轻量高效)
      ja: "PP-OCRv5_server_rec"           # 日文 (使用服务器版)
      korean: "korean_PP-OCRv5_mobile_rec" # 韩文
      fr: "latin_PP-OCRv5_mobile_rec"     # 法语
      de: "latin_PP-OCRv5_mobile_rec"     # 德语
      es: "latin_PP-OCRv5_mobile_rec"     # 西班牙语
      it: "latin_PP-OCRv5_mobile_rec"     # 意大利语
      pt: "latin_PP-OCRv5_mobile_rec"     # 葡萄牙语
      ru: "eslav_PP-OCRv5_mobile_rec"     # 俄语
      th: "th_PP-OCRv5_mobile_rec"        # 泰语
      ar: "ar_PP-OCRv5_mobile_rec"        # 阿拉伯语
      default: "PP-OCRv5_server_rec"      # 默认回退模型
    
    # 字幕场景优化设置
    subtitle_optimized: true  # 启用字幕场景优化
    # 注意：PaddleOCR 3.x已移除 use_angle_cls 和 use_space_char 参数
    # 优化主要通过语言选择和模型配置实现

# 5. OCR 服务端配置
ocr_server:
  # 是否启用 OCR 服务端模式。
  # - true: 流水线将使用下面的 url 连接 OCR 服务，实现高并发处理。
  # - false: 流水线将回退到在本地创建 PaddleOCR 实例的传统模式。
  enabled: true
  # PaddleOCR Hub Serving 服务的预测 URL。
  # 如果 ocr-server 和主应用在同一个 docker-compose 网络中，可以直接使用服务名 "ocr-server"。
  # 如果在宿主机上直接运行 python 脚本测试，请使用 "http://localhost:8868/predict/ocr_system"。
  url: "http://ocr-server:8868/predict/ocr_system"
  # 客户端向服务器发送请求时的批处理大小。
  # 可根据服务端的能力和网络情况调整。
  batch_size: 16

# 5. 后处理器模块配置
postprocessor:
  # 一条字幕被认为是有效的最小持续时间（单位：秒）。用于过滤掉因检测错误而产生的快速闪现的无效字幕。
  # 建议值: 0.1 ~ 0.5
  min_duration_seconds: 0.2
