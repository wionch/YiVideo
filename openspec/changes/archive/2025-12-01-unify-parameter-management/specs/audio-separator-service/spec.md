# 音频分离服务参数管理统一规范

## ADDED Requirements

### Requirement: 统一音频源参数获取逻辑

音频分离任务**SHALL**使用统一的参数获取机制，通过 `get_param_with_fallback` 函数实现多级参数回退。

#### 当前实现（存在问题）
音频分离任务在 `audio_separator_service/app/tasks.py` 中使用手动参数回退逻辑（第118-126行），存在以下问题：
- 代码重复，与其他服务不一致
- 不支持完整的单任务模式特性
- 维护复杂，难以扩展

#### 期望行为（统一后）
```python
# 统一的参数获取方式
audio_path = get_param_with_fallback(
    "audio_path", 
    resolved_params, 
    workflow_context,
    fallback_from_input_data=True,
    fallback_from_stage="ffmpeg.extract_audio"
)
```

#### 保持不变的行为
- 智能音频源选择的优先级逻辑：人声音频 → 默认音频 → 参数传入
- 输入文件验证和下载逻辑
- 音频分离核心功能
- 输出数据结构和格式

#### Scenario: 单任务模式参数获取
- **WHEN** 通过 `/v1/tasks` 接口调用 `audio_separator.separate_vocals`
- **AND** 提供 `input_data.audio_path` 或 `input_data.video_path`
- **THEN** 系统应正确获取音频文件路径并执行分离
- **验证点**: 支持动态引用 `${{...}}` 语法

#### Scenario: 工作流模式参数回退
- **WHEN** 在工作流中调用 `audio_separator.separate_vocals`
- **AND** 未在节点参数中明确提供 `audio_path`
- **THEN** 系统应回退到上游节点 `ffmpeg.extract_audio` 的输出
- **验证点**: 智能源选择逻辑保持完全一致

#### Scenario: 错误处理和日志
- **WHEN** 参数获取失败或文件不存在
- **THEN** 应提供清晰的错误信息，包含音频源选择的调试信息
- **验证点**: 日志应记录实际使用的音频源和路径

### Requirement: 兼容性保证

音频分离服务**MUST**保持与现有工作流配置的完全兼容性。

#### 兼容性要求
- ✅ 现有工作流配置无需修改
- ✅ API调用方式保持一致
- ✅ 智能音频源选择行为不变
- ✅ 输出数据格式完全兼容

#### Scenario: 现有工作流兼容性
- **WHEN** 使用现有的工作流配置调用音频分离任务
- **THEN** 系统应产生与重构前完全相同的结果
- **验证点**: 输出文件路径、内容和元数据完全一致

#### Scenario: 错误情况兼容性
- **WHEN** 遇到文件不存在或权限错误时
- **THEN** 错误信息和处理方式与重构前相同
- **验证点**: 错误代码、消息和处理逻辑保持一致

## 重要说明

### 修改范围限制
- **修改节点**: 仅 `audio_separator.separate_vocals` 一个节点
- **修改内容**: 仅音频源选择逻辑（第118-126行）
- **功能保持**: 音频分离核心功能、输出格式、错误处理完全不变
- **兼容性**: 现有工作流配置和API调用无需任何修改

### 功能保证
- ✅ 音频分离质量和效果不变
- ✅ 智能音频源选择逻辑保持一致
- ✅ 输出文件格式和内容完全兼容
- ✅ GPU/CPU模式切换正常
- ✅ 单任务模式和工作流模式继续有效

## 验收标准

1. **功能完整性**: 所有现有功能正常工作，无功能回归
2. **参数一致性**: 所有音频源选择场景结果正确
3. **兼容性**: 现有配置和API调用无需修改
4. **代码质量**: 代码复用率高，无重复逻辑
5. **测试覆盖**: 单元测试覆盖率 ≥90%，集成测试全部通过