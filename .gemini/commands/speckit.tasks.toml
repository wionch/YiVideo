description = "根据可用的设计产物，为功能生成可操作的、按依赖顺序排列的 tasks.md。"

prompt = """
---
description: 根据可用的设计产物，为功能生成可操作的、按依赖顺序排列的 tasks.md。
handoffs:
    - label: 分析一致性
      agent: speckit.analyze
      prompt: 运行项目一致性分析
      send: true
    - label: 实施项目
      agent: speckit.implement
      prompt: 分阶段开始实施
      send: true
---

## 语言要求

-   生成的 `tasks.md` 中所有面向用户的任务描述、章节标题和解释**必须**使用中文书写，除非它们是：
    -   文件路径、命令、代码片段或专有技术名称(库/框架/协议名称)。
-   本文件中的命令描述和规则保留英文，但生成的产物 (`tasks.md`) 预期为中文。

## 开发原则

-   **KISS**: 保持简单 (Keep It Simple, Stupid)。优先考虑最简单的实现。
-   **DRY**: 不要重复自己 (Don't Repeat Yourself)。避免重复的逻辑。
-   **SOLID**: 遵守单一职责、开闭、里氏替换、接口隔离和依赖倒置原则。
-   **YAGNI**: 你不会需要它 (You Ain't Gonna Need It)。仅实现明确要求的内容。

## 用户输入

```text
$ARGUMENTS
```

如果用户输入不为空，你**必须**在继续之前考虑它。

## 大纲

1. **设置**: 从仓库根目录运行 `.specify/scripts/bash/check-prerequisites.sh --json` 并解析 FEATURE_DIR 和 AVAILABLE_DOCS 列表。所有路径必须是绝对路径。对于像 "I'm Groot" 这样的参数中的单引号，请使用转义语法：例如 'I\\'m Groot'(或者如果可能，使用双引号："I'm Groot")。

2. **加载设计文档**: 从 FEATURE_DIR 读取：

    - **必须**: plan.md (技术栈, 库, 结构), spec.md (具有优先级的用户故事)
    - **可选**: data-model.md (实体), contracts/ (API 端点), research.md (决策), quickstart.md (测试场景)
    - 注意：并非所有项目都有所有文档。根据可用内容生成任务。

3. **执行任务生成工作流**:

    - 加载 plan.md 并提取技术栈、库、项目结构
    - 加载 spec.md 并提取具有优先级的用户故事 (P1, P2, P3 等)
    - 如果存在 data-model.md：提取实体并映射到用户故事
    - 如果存在 contracts/：将端点映射到用户故事
    - 如果存在 research.md：提取设置任务的决策
    - 按用户故事组织生成任务(见下文任务生成规则)
    - 生成显示用户故事完成顺序的依赖图
    - 每个用户故事创建并行执行示例
    - 验证任务完整性(每个用户故事都有所有需要的任务，可独立测试)

4. **生成 tasks.md**: 使用 `.specify/templates/tasks-template.md` 作为结构，填充：

    - 来自 plan.md 的正确功能名称
    - 阶段 1: 设置任务(项目初始化)
    - 阶段 2: 基础任务(所有用户故事的阻塞先决条件)
    - 阶段 3+: 每个用户故事一个阶段(按 spec.md 中的优先级顺序)
    - 每个阶段包括：故事目标、独立测试标准、测试(如果请求)、实施任务
    - 最后阶段：完善与横切关注点
    - 所有任务必须遵循严格的核查清单格式(见下文任务生成规则)
    - 每个任务的清晰文件路径
    - 显示故事完成顺序的依赖部分
    - 每个故事的并行执行示例
    - 实施策略部分(MVP 优先，增量交付)

5. **报告**: 输出生成的 tasks.md 的路径和摘要：
    - 总任务数
    - 每个用户故事的任务数
    - 识别的并行机会
    - 每个故事的独立测试标准
    - 建议的 MVP 范围(通常仅用户故事 1)
    - 格式验证：确认所有任务都遵循核查清单格式(复选框、ID、标签、文件路径)

任务生成的上下文: $ARGUMENTS

tasks.md 应立即可执行 - 每个任务必须足够具体，以便 LLM 可以在没有额外上下文的情况下完成它。

## 任务生成规则

**关键**: 任务必须按用户故事组织，以实现独立的实施和测试。

**测试是可选的**: 仅在功能规范中明确请求或用户请求 TDD 方法时生成测试任务。

### 核查清单格式(必须)

每个任务必须严格遵循此格式：

```text
- [ ] [TaskID] [P?] [Story?] Description with file path
```

**格式组件**:

1. **复选框**: 始终以 `- [ ]` 开始(markdown 复选框)
2. **任务 ID**: 执行顺序中的序列号 (T001, T002, T003...)
3. **[P] 标记**: 仅当任务可并行化时包含(不同文件，不依赖于未完成的任务)
4. **[Story] 标签**: 仅用户故事阶段任务必须
    - 格式: [US1], [US2], [US3] 等(映射到 spec.md 中的用户故事)
    - 设置阶段: 无故事标签
    - 基础阶段: 无故事标签
    - 用户故事阶段: 必须有故事标签
    - 完善阶段: 无故事标签
5. **描述**: 带有确切文件路径的清晰动作

**示例**:

-   ✅ 正确: `- [ ] T001 Create project structure per implementation plan`
-   ✅ 正确: `- [ ] T005 [P] Implement authentication middleware in src/middleware/auth.py`
-   ✅ 正确: `- [ ] T012 [P] [US1] Create User model in src/models/user.py`
-   ✅ 正确: `- [ ] T014 [US1] Implement UserService in src/services/user_service.py`
-   ❌ 错误: `- [ ] Create User model` (缺少 ID 和故事标签)
-   ❌ 错误: `T001 [US1] Create model` (缺少复选框)
-   ❌ 错误: `- [ ] [US1] Create User model` (缺少任务 ID)
-   ❌ 错误: `- [ ] T001 [US1] Create model` (缺少文件路径)

### 任务组织

1. **来自用户故事 (spec.md)** - 主要组织：

    - 每个用户故事 (P1, P2, P3...) 都有自己的阶段
    - 将所有相关组件映射到它们的故事：
        - 该故事所需的模型
        - 该故事所需的服务
        - 该故事所需的端点/UI
        - 如果请求测试：特定于该故事的测试
    - 标记故事依赖关系(大多数故事应该是独立的)

2. **来自合约**:

    - 将每个合约/端点 → 映射到它服务的用户故事
    - 如果请求测试：每个合约 → 该故事阶段实施前的合约测试任务 [P]

3. **来自数据模型**:

    - 将每个实体映射到需要它的用户故事
    - 如果实体服务于多个故事：放在最早的故事或设置阶段
    - 关系 → 适当故事阶段中的服务层任务

4. **来自设置/基础设施**:
    - 共享基础设施 → 设置阶段(阶段 1)
    - 基础/阻塞任务 → 基础阶段(阶段 2)
    - 故事特定的设置 → 在该故事的阶段内

### 阶段结构

-   **阶段 1**: 设置(项目初始化)
-   **阶段 2**: 基础(阻塞先决条件 - 必须在用户故事之前完成)
-   **阶段 3+**: 按优先级顺序的用户故事 (P1, P2, P3...)
    -   在每个故事内：测试(如果请求) → 模型 → 服务 → 端点 → 集成
    -   每个阶段应是一个完整的、可独立测试的增量
-   **最后阶段**: 完善与横切关注点

### 任务的原子性要求(必须)

-   每个任务必须足够原子化，可以在单个、范围明确的编辑会话中完成，而不依赖于任务本身引用之外的隐式上下文。
-   任务必须针对以下至少一个粒度“执行单元”：
    -   代码级单元：具体文件路径加上类/函数/常量/模块名称，或清晰描述的代码块范围。
    -   文档级单元：具体文件路径加上标题级别 (H2/H3) 和章节标题。
    -   信息源单元：具体 URL/版本/日期加上一小列 (≤ 5) 预期结论要点。
-   每个任务描述必须明确包含三个方面(可以是内联的，但必须清晰)：
    -   **输入**: 它依赖哪些文件/符号/决策(路径或显式引用)。
    -   **输出**: 预期有什么新内容或修改内容(路径 + 符号/章节)。
    -   **验收**: 决定任务是否完成的客观标准(避免模糊措辞如“看起来更好”或“更清晰”)。

### MCP 使用要求(必须)

-   在生成任务时，如果有任何关于以下方面的不确定性：
    -   确切在代码库的何处应用更改，
    -   如何将工作拆分为原子任务，
    -   或者遵循哪些最佳实践，
        工作流**必须**按此顺序优先使用 MCP 服务：
    1. `sequential-thinking`：分解和排序任务，并识别依赖关系和风险。
    2. `serena`：定位仓库中的文件/符号/引用和附近的实现模式。
    3. `context7`：查阅外部权威来源并在决策中捕获链接/版本。
-   **强制：路径与引用真实性**：
-   任何写入 tasks.md 的"文件路径/模块名/符号名"，若不是来自 plan.md 明确信号，必须先用 `serena` 验证其存在或给出最接近的落点；禁止凭空生成看似合理但不存在的路径。
-   **强制：外部最佳实践可追溯**：
-   若某个任务依赖外部标准/最佳实践(安全、隐私、可访问性、合规等)，必须在任务描述或阶段说明中附带最小来源记录(URL + 版本/日期 + 结论要点)。
-   如果 MCP 服务不可用，生成器**必须**添加一个显式的"注释任务"来解释：
    -   预期哪个 MCP 服务，
    -   为什么无法使用，
    -   以及应查阅哪些替代信息源(文件/提交/URL)。
"""
