# Tasks: callback å¤ç”¨è¦†ç›–ä¿®å¤

**Input**: è®¾è®¡æ–‡æ¡£ä½äº `/specs/001-fix-callback-reuse/`
**Prerequisites**: plan.mdï¼ˆå¿…éœ€ï¼‰ï¼Œspec.mdï¼ˆå¿…éœ€ï¼‰ï¼Œresearch.mdï¼Œdata-model.mdï¼Œcontracts/

**è¯´æ˜**ï¼šä»»åŠ¡æŒ‰ç”¨æˆ·æ•…äº‹åˆ†ç»„ï¼Œä¾¿äºç‹¬ç«‹å®ç°ä¸éªŒè¯ï¼›æµ‹è¯•æœªè¢«å¼ºåˆ¶è¦æ±‚ï¼Œä½†åŒ…å«å…³é”®é›†æˆéªŒè¯ä»¥è¦†ç›–å¤ç”¨åœºæ™¯ã€‚

## æ ¼å¼: `[ID] [P?] [Story] æè¿°`

- **[P]**: å¯å¹¶è¡Œï¼ˆä¸åŒæ–‡ä»¶ã€æ— ä¾èµ–ï¼‰
- **[Story]**: ç”¨æˆ·æ•…äº‹æ ‡ç­¾ï¼ˆUS1/US2/US3ï¼‰ï¼Œä»…åœ¨ç”¨æˆ·æ•…äº‹é˜¶æ®µä½¿ç”¨
- æè¿°éœ€åŒ…å«æ–‡ä»¶è·¯å¾„ä¸éªŒæ”¶å£å¾„

---

## Phase 1: Setupï¼ˆç¯å¢ƒå‡†å¤‡ï¼‰

- [X] T001 åœ¨ç›®æ ‡å®¹å™¨å†…å®‰è£… pytestï¼ˆè¾“å…¥ï¼šè¿è¡Œä¸­çš„ç›®æ ‡å®¹å™¨ï¼Œå¦‚ api_gatewayï¼›è¾“å‡ºï¼šå®¹å™¨å†…å¯ç”¨ pytestï¼›éªŒæ”¶ï¼š`docker compose exec api_gateway pip install pytest --break-system-packages` æˆåŠŸï¼Œå¦‚é•œåƒä¸éœ€è¯¥å‚æ•°åˆ™å»æ‰ï¼‰
- [X] T002 å¯åŠ¨åŸºç¡€æœåŠ¡ï¼ˆè¾“å…¥ï¼š`docker-compose.yml`ï¼›è¾“å‡ºï¼šRedis/MinIO/workers/api_gateway è¿è¡Œï¼›éªŒæ”¶ï¼š`docker-compose up -d` å `docker-compose ps` æ˜¾ç¤ºæ ¸å¿ƒæœåŠ¡ healthy/upï¼‰

---

## Phase 2: Foundationalï¼ˆåŸºç¡€æ¢³ç†ï¼‰

- [X] T003 ç”Ÿæˆå•ä»»åŠ¡èŠ‚ç‚¹å¤ç”¨æ’æŸ¥æ¸…å• `specs/001-fix-callback-reuse/nodes-checklist.md`ï¼ˆè¾“å…¥ï¼š`docs/technical/reference/SINGLE_TASK_API_REFERENCE.md` èŠ‚ç‚¹ç›®å½•ï¼›è¾“å‡ºï¼šæ¸…å•åˆ—å‡º ffmpegã€faster_whisperã€audio_separatorã€pyannote_audioã€paddleocrã€indexttsã€wservice ç­‰å…¨éƒ¨èŠ‚ç‚¹åŠå¯¹åº”æ–‡æ¡£æ®µè½ï¼›éªŒæ”¶ï¼šæ¸…å•è¦†ç›–æ–‡æ¡£ä¸­å‡ºç°çš„æ‰€æœ‰å•ä»»åŠ¡èŠ‚ç‚¹ï¼Œæ— é—æ¼ï¼‰

---

## Phase 3: User Story 1 - å¤ç”¨å‘½ä¸­ä¿æŒé˜¶æ®µå®Œæ•´ (Priority: P1) ğŸ¯ MVP

**Goal**: å‘½ä¸­å¤ç”¨æ—¶è¿”å›å®Œæ•´ `stages`ï¼Œä¸è¦†ç›–å…¶ä»–èŠ‚ç‚¹æ•°æ®ï¼›é‡å¤æäº¤ä¸è§¦å‘å¤šæ¬¡æ‰§è¡Œã€‚
**Independent Test**: æŒ‰ Quickstart åœºæ™¯ 1â†’2â†’3â†’4 æ‰§è¡Œï¼Œç¬¬å››æ¬¡æå–éŸ³é¢‘åŒæ­¥ `status=completed`ã€`reuse_info.reuse_hit=true`ï¼Œ`stages` ä¿ç•™å†å²ä¸æ–°å¢é˜¶æ®µã€‚

### Implementation for User Story 1

- [X] T004 [US1] ä¿®æ­£åˆå¹¶å†™å…¥é€»è¾‘ï¼Œä¿æŒå…¶ä»–é˜¶æ®µä¸è¢«è¦†ç›–ï¼ˆè¾“å…¥ï¼š`services/api_gateway/app/single_task_executor.py` `_create_task_record`ï¼›è¾“å‡ºï¼šåˆå¹¶æ—¶ä»…æ›´æ–°å½“å‰ `task_name`ï¼Œä¿ç•™å…¶ä»– `stages`ã€`create_at`ã€`shared_storage_path`ã€TTL ä¸å˜ï¼›éªŒæ”¶ï¼šæ¨¡æ‹Ÿå­˜åœ¨ä¸¤ä¸ªé˜¶æ®µçš„ Redis çŠ¶æ€åå†å†™å…¥å½“å‰é˜¶æ®µï¼Œæ£€æŸ¥ Redis è¿”å›ä»åŒ…å«åŸé˜¶æ®µä¸”æœªè¢«æ¸…ç©ºï¼‰
- [X] T005 [P] [US1] ç¡®ä¿å¤ç”¨å‘½ä¸­è¿”å›å®Œæ•´ä¸Šä¸‹æ–‡ä¸”ä½¿ç”¨æœ€æ–°å›è°ƒï¼ˆè¾“å…¥ï¼š`services/api_gateway/app/single_task_executor.py` `_check_reuse`ï¼›è¾“å‡ºï¼šå‘½ä¸­æ—¶ `context.stages` ä¿ç•™æ‰€æœ‰é˜¶æ®µï¼Œ`reuse_info` é™„åŠ ï¼Œ`input_params.callback_url` ç”¨æœ€æ–°è¯·æ±‚ï¼›éªŒæ”¶ï¼šå‘½ä¸­å¤ç”¨è°ƒç”¨è¿”å› `status=completed`ï¼ŒRedis ä¸­å…¶ä»–é˜¶æ®µæœªå˜ä¸”å›è°ƒæŒ‡å‘æœ€æ–°åœ°å€ï¼‰
- [X] T006 [US1] æ·»åŠ é›†æˆæµ‹è¯•éªŒè¯å¤ç”¨å‘½ä¸­ä¸é˜¶æ®µç´¯ç§¯ï¼ˆè¾“å…¥ï¼š`tests/integration/test_single_task_reuse.py` æ–°å¢ï¼›è¾“å‡ºï¼šè‡ªåŠ¨åŒ–ç”¨ä¾‹è¦†ç›–åœºæ™¯ 1â†’2â†’3â†’4ï¼Œæ–­è¨€ç¬¬å››æ¬¡è¯·æ±‚ `reuse_hit=true` ä¸” `stages` å«æå–+åˆ†ç¦»ï¼›éªŒæ”¶ï¼šåœ¨å®¹å™¨å†…è¿è¡Œ `docker compose exec api_gateway pytest tests/integration/test_single_task_reuse.py` é€šè¿‡ï¼‰

---

## Phase 4: User Story 2 - ç­‰å¾…æ€å¤ç”¨ä¸é‡å¤è°ƒåº¦ (Priority: P2)

**Goal**: `pending/running` å‘½ä¸­æ—¶ä»…è¿”å›ç­‰å¾…æ€ï¼Œä¸åˆ›å»ºæ–°ä»»åŠ¡ã€ä¸æ–°å¢é˜¶æ®µè®°å½•ã€‚
**Independent Test**: åŒä¸€ `task_id+task_name` å¿«é€ŸåŒå‘ï¼Œç¬¬äºŒæ¬¡å“åº” `status=pending`ã€`reuse_info.state=pending`ï¼Œåå°æ— æ–° Celery ä»»åŠ¡ã€‚

### Implementation for User Story 2

- [X] T007 [US2] åŠ å¼ºç­‰å¾…æ€åˆ†æ”¯ï¼Œç¡®ä¿ä¸äºŒæ¬¡è°ƒåº¦ä¸”è®°å½•å¤ç”¨æ ‡è¯†ï¼ˆè¾“å…¥ï¼š`services/api_gateway/app/single_task_executor.py` `_check_reuse` ä¸ `execute_task` å¤ç”¨åˆ†æ”¯ï¼›è¾“å‡ºï¼šç­‰å¾…æ€ç›´æ¥è¿”å›ã€ä¸ä¸­æ–­ç°æœ‰æ‰§è¡Œã€ä¸å†™å…¥æ–°é˜¶æ®µï¼›éªŒæ”¶ï¼šè¿ç»­ä¸¤æ¬¡ç›¸åŒè¯·æ±‚ï¼Œç¬¬äºŒæ¬¡æ— æ–°çš„ `celery_task_id` ç”Ÿæˆï¼ŒRedis `stages` æœªå¢åŠ æ–°æ¡ç›®ï¼‰
- [X] T008 [P] [US2] æ·»åŠ ç­‰å¾…æ€é›†æˆæµ‹è¯•ï¼ˆè¾“å…¥ï¼š`tests/integration/test_single_task_reuse.py` æ‰©å±•æˆ–æ–°å¢ç”¨ä¾‹ï¼›è¾“å‡ºï¼šç”¨ä¾‹æ–­è¨€ç¬¬äºŒæ¬¡è¯·æ±‚è¿”å› `status=pending`ã€`reuse_info.state=pending`ï¼Œä»»åŠ¡æ€»æ•°ä¸å¢ï¼›éªŒæ”¶ï¼šåœ¨å®¹å™¨å†…è¿è¡Œ `docker compose exec api_gateway pytest tests/integration/test_single_task_reuse.py -k pending` è¦†ç›–è¯¥æ–­è¨€ï¼‰

---

## Phase 5: User Story 3 - æ–‡æ¡£è¦†ç›–æ‰€æœ‰èŠ‚ç‚¹å¤ç”¨è§„åˆ™ (Priority: P3)

**Goal**: `SINGLE_TASK_API_REFERENCE.md` ä¸­æ¯ä¸ªå•ä»»åŠ¡èŠ‚ç‚¹å‡å±•ç¤ºå¤ç”¨åˆ¤å®šã€å‘½ä¸­/ç­‰å¾…/æœªå‘½ä¸­ç¤ºä¾‹ä¸å­—æ®µã€‚
**Independent Test**: æ£€æŸ¥æ–‡æ¡£å„èŠ‚ç‚¹å°èŠ‚èƒ½æ‰¾åˆ°å¤ç”¨åˆ¤å®šæ¡ä»¶ä¸ `reuse_info` ç¤ºä¾‹ã€‚

### Implementation for User Story 3

- [X] T009 [US3] æ›´æ–°é€šç”¨å¤ç”¨è¯´æ˜æ®µè½ï¼Œæ˜ç¡®å…¨èŠ‚ç‚¹é€‚ç”¨ä¸å­—æ®µå«ä¹‰ï¼ˆè¾“å…¥ï¼š`docs/technical/reference/SINGLE_TASK_API_REFERENCE.md` å¤ç”¨ç« èŠ‚ï¼›è¾“å‡ºï¼šåŒ…å«åˆ¤å®šæ¡ä»¶ã€å‘½ä¸­/ç­‰å¾…/æœªå‘½ä¸­è¿”å›å½¢æ€ã€`reuse_info` å­—æ®µè¡¨è¿°ï¼›éªŒæ”¶ï¼šæ–‡æ¡£å¤ç”¨æ®µè½å¯ç‹¬ç«‹è§£é‡Šå…¨å±€è§„åˆ™ï¼‰
- [X] T010 [US3] è¡¥å…… ffmpeg ç³»åˆ—èŠ‚ç‚¹å¤ç”¨ç¤ºä¾‹ä¸å­—æ®µï¼ˆè¾“å…¥ï¼šåŒæ–‡ä»¶å¯¹åº” ffmpeg.* å°èŠ‚ï¼›è¾“å‡ºï¼šæ¯ä¸ªèŠ‚ç‚¹å±•ç¤ºå‘½ä¸­ã€ç­‰å¾…ã€æœªå‘½ä¸­ç¤ºä¾‹/å­—æ®µï¼ŒæŒ‡æ˜å…³é”®è¾“å‡ºç”¨äºåˆ¤å®šï¼›éªŒæ”¶ï¼šffmpeg å°èŠ‚å‡æœ‰å¤ç”¨è¯´æ˜ä¸”å­—æ®µä¸ä»£ç è¡Œä¸ºä¸€è‡´ï¼‰
- [X] T011 [US3] è¡¥å……å…¶ä»–èŠ‚ç‚¹ï¼ˆfaster_whisper/audio_separator/pyannote_audio/paddleocr/indextts/wservice ç­‰ï¼‰å¤ç”¨ç¤ºä¾‹ä¸å­—æ®µï¼ˆè¾“å…¥ï¼šåŒæ–‡ä»¶å¯¹åº”èŠ‚ç‚¹å°èŠ‚ï¼›è¾“å‡ºï¼šæ¯ä¸ªèŠ‚ç‚¹å°èŠ‚å†™æ˜åˆ¤å®šæ¡ä»¶å’Œ `reuse_info` ç¤ºä¾‹ï¼Œè¦†ç›–å…¨éƒ¨èŠ‚ç‚¹æ¸…å•ï¼›éªŒæ”¶ï¼šå¯¹ç…§ T003 æ¸…å•ç¡®è®¤æ— é—æ¼ï¼‰

---

## Phase N: Polish & Cross-Cutting

- [ ] T012 è¿è¡Œ Quickstart æ ¸å¿ƒç”¨ä¾‹å¹¶è®°å½•ç»“æœï¼ˆè¾“å…¥ï¼š`specs/001-fix-callback-reuse/quickstart.md` æ­¥éª¤ï¼›è¾“å‡ºï¼šå®é™…è°ƒç”¨æ—¥å¿—ä¸å“åº”ï¼›éªŒæ”¶ï¼šæ­¥éª¤ 1â†’2â†’3â†’4 å…¨éƒ¨è¾¾åˆ°é¢„æœŸçŠ¶æ€ä¸ `reuse_info`ï¼Œæµ‹è¯•å‘½ä»¤åœ¨å®¹å™¨å†…æ‰§è¡Œï¼‰
- [ ] T013 æ±‡æ€»éªŒè¯ç»“æœå¹¶æ›´æ–° `specs/001-fix-callback-reuse/research.md` å†³ç­–çŠ¶æ€ï¼ˆè¾“å…¥ï¼šæœ¬æ¬¡å®ç°ä¸æµ‹è¯•ç»“è®ºï¼›è¾“å‡ºï¼šåœ¨ research.md è¿½åŠ éªŒè¯ç»“è®ºï¼›éªŒæ”¶ï¼šç ”ç©¶æ–‡æ¡£åæ˜ ä»£ç /æ–‡æ¡£æ›´æ–°å·²è½å®ï¼‰

---

## Dependencies & Execution Order

- Phase 1 â†’ Phase 2 â†’ ç”¨æˆ·æ•…äº‹é˜¶æ®µï¼ˆP1 ä¼˜å…ˆï¼Œå…¶æ¬¡ P2ï¼Œæœ€å P3ï¼‰â†’ Polishã€‚
- ç”¨æˆ·æ•…äº‹å¯åœ¨å®Œæˆ Phase 2 åå¹¶è¡Œï¼Œä½†å…±äº«æ–‡ä»¶å†²çªéœ€ä¸²è¡Œï¼ˆåŒä¸€æ–‡ä»¶çš„ä»»åŠ¡ä¸æ ‡è®° [P]ï¼‰ã€‚
- Testsï¼ˆT006ã€T008ï¼‰åº”åœ¨å¯¹åº”å®ç°åæ‰§è¡Œã€‚

## Parallel Opportunities

- å¯å¹¶è¡Œï¼šT005 ä¸ T004ï¼ˆä¸åŒé€»è¾‘å—ä½†åŒæ–‡ä»¶ï¼Œå»ºè®®ä¸²è¡Œä»¥é¿å…å†²çªï¼‰ï¼›T003 ä¸ä»£ç å®ç°ç‹¬ç«‹å¯å¹¶è¡Œï¼›T008 ä¸ T006 å¯åœ¨å®ç°å®Œæˆåå¹¶è¡Œæ‰§è¡Œæµ‹è¯•ã€‚

## Implementation Strategy

- å…ˆå®Œæˆç¯å¢ƒä¸æ¸…å•ï¼ˆPhase 1-2ï¼‰ï¼Œç¡®ä¿èŠ‚ç‚¹èŒƒå›´æ˜ç¡®ã€‚
- æŒ‰ä¼˜å…ˆçº§å®Œæˆ US1ï¼ˆæ ¸å¿ƒå¤ç”¨ä¸é˜¶æ®µä¿æŠ¤ï¼‰â†’ US2ï¼ˆç­‰å¾…æ€é˜²é‡å¤è°ƒåº¦ï¼‰â†’ US3ï¼ˆæ–‡æ¡£è¦†ç›–ï¼‰ã€‚
- æ¯å®Œæˆä¸€æ•…äº‹ç«‹å³è¿è¡Œå¯¹åº”æµ‹è¯•/å¿«é€ŸéªŒè¯ï¼Œç¡®ä¿ç‹¬ç«‹å¯äº¤ä»˜ã€‚
