description = "根据用户需求为当前功能生成自定义核查清单。"

prompt = """
---
description: 根据用户需求为当前功能生成自定义核查清单。
---

## 语言要求

-   生成的核查清单项目和问题必须用**中文**书写。
-   文件路径、命令、代码片段和专有技术名称保持原样。

## 开发原则

-   **KISS**: 保持简单 (Keep It Simple, Stupid)。优先考虑最简单的实现。
-   **DRY**: 不要重复自己 (Don't Repeat Yourself)。避免重复的逻辑。
-   **SOLID**: 遵守单一职责、开闭、里氏替换、接口隔离和依赖倒置原则。
-   **YAGNI**: 你不会需要它 (You Ain't Gonna Need It)。仅实现明确要求的内容。

## 核查清单目的：“英语单元测试”

**核心概念**: 核查清单是**需求的单元测试**——它们验证特定领域需求的质量、清晰度和完整性。

**不用于验证/测试**:

-   ❌ 不是“验证按钮点击是否正确”
-   ❌ 不是“测试错误处理是否工作”
-   ❌ 不是“确认 API 返回 200”
-   ❌ 不是检查代码/实现是否符合规范

**用于需求质量验证**:

-   ✅ “所有卡片类型的视觉层次结构需求是否已定义？”(完整性)
-   ✅ “‘突出显示’是否已通过具体尺寸/定位量化？”(清晰度)
-   ✅ “悬停状态需求在所有交互元素中是否一致？”(一致性)
-   ✅ “键盘导航的可访问性需求是否已定义？”(覆盖率)
-   ✅ “规范是否定义了徽标图像加载失败时发生的情况？”(边缘情况)

**隐喻**: 如果你的规范是用英语编写的代码，那么核查清单就是它的单元测试套件。你是在测试需求是否写得好、完整、明确并准备好实施——而不是实现是否有效。

## 用户输入

```text
$ARGUMENTS
```

如果用户输入不为空，你**必须**在继续之前考虑它。

## MCP 使用要求 (必须)

-   生成核查清单前，默认按此顺序使用 MCP：
-   1. `sequential-thinking`：把用户输入信号(领域/风险/受众/深度)结构化成"检查维度"与"覆盖策略"，避免遗漏关键场景类别。
-   2. `serena`：只用于定位 spec/plan/tasks 中的相关段落、术语与 ID，以提升可追溯性引用密度(≥80% 规则不变)。
-   3. `context7`：当用户请求涉及行业标准/合规/安全/可访问性等"外部权威约束"时，用于获取可引用的基准(并在核查清单元信息中记录来源)。
-   若任一 MCP 不可用：必须在生成的核查清单文件头部增加一段"工具不可用说明"(缺失项、原因、替代来源、可能遗漏的维度)。

## 执行步骤

1. **设置**: 从仓库根目录运行 `.specify/scripts/bash/check-prerequisites.sh --json` 并解析 JSON 以获取 FEATURE_DIR 和 AVAILABLE_DOCS 列表。
   - 所有文件路径必须是绝对路径。
   - 对于像 "I'm Groot" 这样的参数中的单引号，请使用转义语法：例如 'I\\'m Groot'(或者如果可能，使用双引号："I'm Groot")。

2. **澄清意图(动态)**: 提出最多三个初始上下文澄清问题(没有预设目录)。它们必须：
   - 从用户的措辞 + 从 spec/plan/tasks 中提取的信号生成
   - 仅询问实质性改变核查清单内容的信息
   - 如果在 `$ARGUMENTS` 中已经明确，则单独跳过
   - 优先考虑精确性而非广度

   生成算法：
   1. 提取信号：功能领域关键字(例如，auth, latency, UX, API)，风险指标("critical", "must", "compliance")，利益相关者提示("QA", "review", "security team")，以及明确的可交付成果("a11y", "rollback", "contracts")。
   2. 将信号聚类为候选关注领域(最多 4 个)，按相关性排序。
   3. 如果不明确，确定可能的受众和时间安排(作者、审阅者、QA、发布)。
   4. 检测缺失的维度：范围广度、深度/严谨性、风险重点、排除边界、可衡量的验收标准。
   5. 制定从这些原型中选择的问题：
      - 范围细化(例如，“这应该包括与 X 和 Y 的集成接触点，还是仅限于本地模块的正确性？”)
      - 风险优先级(例如，“这些潜在风险领域中的哪一个应接受强制性门槛检查？”)
      - 深度校准(例如，“这是一个轻量级的预提交健全性列表还是正式的发布门槛？”)
      - 受众框架(例如，“这仅供作者使用，还是在 PR 审查期间供同行使用？”)
      - 边界排除(例如，“我们这一轮应该明确排除性能调优项目吗？”)
      - 场景类缺口(例如，“未检测到恢复流程——回滚/部分失败路径是否在范围内？”)

   问题格式规则：
   - 如果提供选项，生成一个包含列的紧凑表格：选项 | 候选 | 为什么重要
   - 最多限制 A–E 选项；如果自由形式的答案更清晰，则省略表格
   - 永远不要让用户重述他们已经说过的话
   - 避免推测性类别(不要产生幻觉)。如果不确定，请明确询问：“确认 X 是否属于范围。”

   交互不可能时的默认值：
   - 深度：标准
   - 受众：如果是代码相关则为审阅者 (PR)；否则为作者
   - 重点：前 2 个相关性聚类

   输出问题(标记 Q1/Q2/Q3)。回答后：如果 ≥2 个场景类(备用/异常/恢复/非功能领域)仍不清楚，你可以再问最多两个针对性的后续问题(Q4/Q5)，每个问题附带一行理由(例如，“未解决的恢复路径风险”)。总共不要超过五个问题。如果用户明确拒绝更多问题，请跳过升级。

3. **理解用户请求**: 结合 `$ARGUMENTS` + 澄清答案：
   - 推导核查清单主题(例如，security, review, deploy, ux)
   - 合并用户提到的明确必须具备的项目
   - 将焦点选择映射到类别脚手架
   - 从 spec/plan/tasks 推断任何缺失的上下文(不要产生幻觉)

4. **加载功能上下文**: 从 FEATURE_DIR 读取：
   - spec.md: 功能需求和范围
   - plan.md (如果存在): 技术细节、依赖项
   - tasks.md (如果存在): 实施任务

   **上下文加载策略**:
   - 仅加载与活动关注领域相关的必要部分(避免全文件转储)
   - 优先将长部分总结为简洁的场景/需求要点
   - 使用渐进式披露：仅在检测到缺口时添加后续检索
   - 如果源文档很大，生成临时摘要项而不是嵌入原始文本

5. **生成核查清单** - 创建“需求单元测试”:
   - 如果不存在，创建 `FEATURE_DIR/checklists/` 目录
   - 生成唯一的核查清单文件名：
     - 使用基于领域的简短描述性名称(例如，`ux.md`, `api.md`, `security.md`)
     - 格式：`[domain].md`
     - 如果文件存在，追加到现有文件
   - 从 CHK001 开始按顺序编号项目
   - 每次 `/speckit.checklist` 运行都会创建一个新文件(从不覆盖现有核查清单)

   **核心原则 - 测试需求，而非实现**:
   每个核查清单项目必须评估需求本身：
   - **完整性**: 所有必要的需求都存在吗？
   - **清晰度**: 需求是否明确且具体？
   - **一致性**: 需求是否彼此一致？
   - **可衡量性**: 需求是否可以客观验证？
   - **覆盖率**: 是否解决了所有场景/边缘情况？

   **类别结构** - 按需求质量维度分组项目：
   - **需求完整性** (所有必要的需求都记录了吗？)
   - **需求清晰度** (需求是否具体且明确？)
   - **需求一致性** (需求是否一致且无冲突？)
   - **验收标准质量** (成功标准是否可衡量？)
   - **场景覆盖率** (是否解决了所有流程/案例？)
   - **边缘情况覆盖率** (边界条件是否已定义？)
   - **非功能需求** (性能、安全、可访问性等 - 它们是否已指定？)
   - **依赖项与假设** (它们是否已记录并验证？)
   - **歧义与冲突** (什么需要澄清？)

   **如何编写核查清单项目 - "英语单元测试"**:

   ❌ **错误** (测试实现):
   - "验证着陆页显示 3 个剧集卡片"
   - "测试桌面上的悬停状态是否工作"
   - "确认点击徽标导航到主页"

   ✅ **正确** (测试需求质量):
   - "特色剧集的具体数量和布局是否已指定？" [完整性]
   - "‘突出显示’是否已通过具体尺寸/定位量化？" [清晰度]
   - "悬停状态需求在所有交互元素中是否一致？" [一致性]
   - "是否为所有交互式 UI 定义了键盘导航需求？" [覆盖率]
   - "规范是否定义了徽标图像加载失败时的回退行为？" [边缘情况]
   - "是否定义了异步剧集数据的加载状态？" [完整性]
   - "规范是否定义了竞争 UI 元素的视觉层次结构？" [清晰度]

   **项目结构**:
   每个项目应遵循此模式：
   - 询问需求质量的问题格式
   - 关注 spec/plan 中写了什么(或没写什么)
   - 在括号中包含质量维度 [完整性/清晰度/一致性/等]
   - 检查现有需求时引用规范章节 `[Spec §X.Y]`
   - 检查缺失需求时使用 `[缺口]` 标记

   **按质量维度的示例**:

   完整性:
   - "是否为所有 API 故障模式定义了错误处理需求？ [缺口]"
   - "是否为所有交互元素指定了可访问性需求？ [完整性]"
   - "是否为响应式布局定义了移动断点需求？ [缺口]"

   清晰度:
   - "‘快速加载’是否通过具体的时间阈值量化？ [清晰度, Spec §NFR-2]"
   - "‘相关剧集’的选择标准是否明确定义？ [清晰度, Spec §FR-5]"
   - "‘突出’是否定义了可衡量的视觉属性？ [歧义, Spec §FR-4]"

   一致性:
   - "导航需求在所有页面上是否一致？ [一致性, Spec §FR-10]"
   - "着陆页和详情页之间的卡片组件需求是否一致？ [一致性]"

   覆盖率:
   - "是否定义了零状态场景(无剧集)的需求？ [覆盖率, 边缘情况]"
   - "是否解决了并发用户交互场景？ [覆盖率, 缺口]"
   - "是否指定了部分数据加载失败的需求？ [覆盖率, 异常流程]"

   可衡量性:
   - "视觉层次结构需求是否可衡量/可测试？ [验收标准, Spec §FR-1]"
   - "‘平衡的视觉权重’能否被客观验证？ [可衡量性, Spec §FR-2]"

   **场景分类与覆盖率** (需求质量焦点):
   - 检查是否存在以下需求：主要、备用、异常/错误、恢复、非功能场景
   - 对于每个场景类，询问：" [场景类型] 需求是否完整、清晰且一致？"
   - 如果缺少场景类：" [场景类型] 需求是故意排除还是缺失？ [缺口]"
   - 当发生状态突变时包括弹性/回滚："是否定义了迁移失败的回滚需求？ [缺口]"

   **可追溯性需求**:
   - 最低要求：≥80% 的项目必须包含至少一个可追溯性引用
   - 每个项目应引用：规范章节 `[Spec §X.Y]`，或使用标记：`[缺口]`, `[歧义]`, `[冲突]`, `[假设]`
   - 如果不存在 ID 系统："是否建立了需求和验收标准 ID 方案？ [可追溯性]"

   **提出并解决问题** (需求质量问题):
   询问有关需求本身的问题：
   - 歧义："‘快速’一词是否通过具体指标量化？ [歧义, Spec §NFR-1]"
   - 冲突："§FR-10 和 §FR-10a 之间的导航需求是否冲突？ [冲突]"
   - 假设："‘始终可用的播客 API’的假设是否已验证？ [假设]"
   - 依赖项："外部播客 API 需求是否已记录？ [依赖项, 缺口]"
   - 缺失定义："‘视觉层次结构’是否定义了可衡量的标准？ [缺口]"

   **内容合并**:
   - 软上限：如果原始候选项目 > 40，按风险/影响确定优先级
   - 合并检查相同需求方面的近似重复项
   - 如果 >5 个低影响边缘情况，创建一个项目："需求中是否解决了边缘情况 X, Y, Z？ [覆盖率]"

   **🚫 绝对禁止** - 这些使其成为实现测试，而不是需求测试：
   - ❌ 任何以“验证”、“测试”、“确认”、“检查”+ 实现行为开头的项目
   - ❌ 引用代码执行、用户操作、系统行为
   - ❌ "显示正确"、"工作正常"、"如预期运行"
   - ❌ "点击"、"导航"、"渲染"、"加载"、"执行"
   - ❌ 测试用例、测试计划、QA 程序
   - ❌ 实现细节(框架、API、算法)

   **✅ 必需模式** - 这些测试需求质量：
   - ✅ "是否为 [场景] 定义/指定/记录了 [需求类型]？"
   - ✅ "[模糊术语] 是否通过具体标准量化/澄清？"
   - ✅ "[章节 A] 和 [章节 B] 之间的需求是否一致？"
   - ✅ "[需求] 是否可以客观衡量/验证？"
   - ✅ "需求中是否解决了 [边缘情况/场景]？"
   - ✅ "规范是否定义了 [缺失方面]？"

6. **结构参考**: 按照 `.specify/templates/checklist-template.md` 中的规范模板生成核查清单，包括标题、元数据部分、类别标题和 ID 格式。如果模板不可用，请使用：H1 标题、目的/创建元数据行、包含 `- [ ] CHK### <需求项目>` 行(以 CHK001 开始全局递增 ID)的 `##` 类别部分。

7. **报告**: 输出创建的核查清单的完整路径、项目计数，并提醒用户每次运行都会创建一个新文件。总结：
   - 选择的重点领域
   - 深度级别
   - 参与者/时间安排
   - 合并的任何用户指定的必须具备的项目

**重要**: 每次 `/speckit.checklist` 命令调用都会使用简短的描述性名称创建一个核查清单文件，除非文件已存在。这允许：

- 不同类型的多个核查清单(例如，`ux.md`, `test.md`, `security.md`)
- 简单、易记的文件名，指示核查清单目的
- 轻松识别和导航 `checklists/` 文件夹

为了避免混乱，请使用描述性类型并在完成后清理过时的核查清单。

## 示例核查清单类型和样本项目

**UX 需求质量:** `ux.md`

样本项目(测试需求，而非实现):

- "视觉层次结构需求是否定义了可衡量的标准？ [清晰度, Spec §FR-1]"
- "UI 元素的数量和位置是否已明确指定？ [完整性, Spec §FR-1]"
- "交互状态需求(悬停、焦点、活动)是否定义一致？ [一致性]"
- "是否为所有交互元素指定了可访问性需求？ [覆盖率, 缺口]"
- "当图像加载失败时，是否定义了回退行为？ [边缘情况, 缺口]"
- "‘突出显示’能否被客观衡量？ [可衡量性, Spec §FR-4]"

**API 需求质量:** `api.md`

样本项目:

- "是否为所有故障场景指定了错误响应格式？ [完整性]"
- "速率限制需求是否通过具体阈值量化？ [清晰度]"
- "所有端点的身份验证需求是否一致？ [一致性]"
- "是否为外部依赖定义了重试/超时需求？ [覆盖率, 缺口]"
- "需求中是否记录了版本控制策略？ [缺口]"

**性能需求质量:** `performance.md`

样本项目:

- "性能需求是否通过具体指标量化？ [清晰度]"
- "是否为所有关键用户旅程定义了性能目标？ [覆盖率]"
- "是否指定了不同负载条件下的性能需求？ [完整性]"
- "性能需求能否被客观衡量？ [可衡量性]"
- "是否为高负载场景定义了降级需求？ [边缘情况, 缺口]"

**安全需求质量:** `security.md`

样本项目:

- "是否为所有受保护资源指定了身份验证需求？ [覆盖率]"
- "是否为敏感信息定义了数据保护需求？ [完整性]"
- "威胁模型是否已记录且需求与其一致？ [可追溯性]"
- "安全需求是否与合规义务一致？ [一致性]"
- "是否定义了安全故障/违规响应需求？ [缺口, 异常流程]"

## 反例：不该做什么

**❌ 错误 - 这些测试实现，而非需求:**

```markdown
- [ ] CHK001 - Verify landing page displays 3 episode cards [Spec §FR-001]
- [ ] CHK002 - Test hover states work correctly on desktop [Spec §FR-003]
- [ ] CHK003 - Confirm logo click navigates to home page [Spec §FR-010]
- [ ] CHK004 - Check that related episodes section shows 3-5 items [Spec §FR-005]
```

**✅ 正确 - 这些测试需求质量:**

```markdown
- [ ] CHK001 - 特色剧集的数量和布局是否已明确指定？ [完整性, Spec §FR-001]
- [ ] CHK002 - 悬停状态需求在所有交互元素中是否一致定义？ [一致性, Spec §FR-003]
- [ ] CHK003 - 所有可点击品牌元素的导航需求是否清晰？ [清晰度, Spec §FR-010]
- [ ] CHK004 - 相关剧集的选择标准是否已记录？ [缺口, Spec §FR-005]
- [ ] CHK005 - 是否定义了异步剧集数据的加载状态需求？ [缺口]
- [ ] CHK006 - "视觉层次结构"需求能否被客观衡量？ [可衡量性, Spec §FR-001]
```

**关键区别:**

- 错误: 测试系统是否正常工作
- 正确: 测试需求是否编写正确
- 错误: 行为验证
- 正确: 需求质量验证
- 错误: "它做 X 吗？"
- 正确: "X 是否被明确指定？"
"""
