# 字幕重构全局语义断句优先设计

## 1. 背景与现状
当前字幕重构流程为：AI 优化文本 → 词级对齐 → 断句重构。实测发现断句存在语义不完整与极短片段问题，例如：
- 缩写被拆分：`U.S.` 断成 `U.` + `S.`，产生极短字幕。
- 连字符断裂：`snap-trap` 被拆成 `snap-` 与 `-trap` 分属不同片段。
- 弱标点分割导致 `So,` 单独成段。

系统已有 PySBD 语义断句集成（可选依赖），但目前仅对“超长片段”启用，且若依赖未安装会回退到兜底策略。

## 2. 目标与约束
**目标（语义优先）：**
- 全局语义句界优先，避免破坏语义完整性。
- 避免极短字幕与缩写/连字符断裂。

**硬性约束：**
- **词级时间戳不允许偏移**（`word.start/end` 原样保留）。
- 重构仅允许修改“词级文本内容”和“词归属片段”，禁止改变词顺序。

## 3. 方案概览（全局语义句界优先）
将断句主导权从“强标点/兜底”改为 **“PySBD 全局语义句界优先”**。流程为：
1) 词级对齐后，构建连续文本视图（含空格/标点），并记录每个词对应的字符区间。
2) 用 PySBD 对连续文本分句，得到句界字符区间。
3) 将句界映射为词索引区间，形成“语义候选片段”。
4) 仅当候选片段违反 CPL/CPS/时长限制时，才在片段内部进行二次切分（弱标点/停顿）。
5) 对极短片段进行修复（合并或中段平均分割）。

## 4. 核心数据流
1) **词级对齐**：在不改变时间戳的前提下更新 `word.word` 文本。
2) **语义分句**：PySBD 对连续文本分句，输出句子区间。
3) **句界映射**：句子区间 → 词索引区间（不改变词时间戳）。
4) **二次切分**：仅在语义片段超限时切分。
5) **极短片段修复**：对 1-2 字符、且时长过短片段处理。
6) **片段生成**：按词列表组装 `segment.text` 与 `start/end/duration`。

## 5. 关键规则
### 5.1 缩写与连字符保护
- **缩写保护**：将 `U.S.`、`e.g.`、`i.e.` 等视为语义连续，不作为断句点。
- **连字符保护**：`snap-trap`、`state-of-the-art` 不在连字符处分割。
- **空格修复**：当出现 `S.It's` 这类缺失空格的情况，在词级文本修复阶段插入空格（不改变词时间戳）。

### 5.2 极短片段修复（中段平均分割）
当弱标点/停顿切分导致某片段字符数 ≤ 2 且时长 < 0.8s 时：
1) **优先合并**：与同句相邻片段合并，保持语义完整。
2) **中段平均分割**：若合并后超限，则在原片段范围内按“字符中点”寻找最近词边界进行重新切分，保证两侧字符长度更均衡，避免只剩单标点或单字。

## 6. 回退策略
- 若 PySBD 不可用，或句界字符总长度与连续文本不一致，则回退到原“三层策略”（强标点 → 兜底）。
- 回退时仍保留极短片段修复逻辑。

## 7. 测试与验收标准
**首要验收：** 词级时间戳完全一致（输入/输出逐词 `start/end` 不变）。

**核心用例：**
- `U.S. It's ...` 不再断成 `U.` / `S.`。
- `snap-trap` 不跨片段断裂。
- `So,` 不产生单独极短字幕。

**回归指标：**
- CPL/CPS/时长限制不退化；
- 语义句界更自然，片段数减少或稳定。

## 8. 影响范围（预估）
- 断句核心：`services/common/subtitle/segmenter.py`
- 词级对齐：`services/common/subtitle/word_level_aligner.py`
- 重构入口：`services/workers/wservice/executors/rebuild_subtitle_with_words_executor.py`

## 9. 风险与取舍
- 全局语义优先会减少强标点切分机会，可能在极端场景下出现较长片段，需要依赖二次切分兜底。
- 若文本与词级对齐存在噪声，句界映射可能偏差，需可靠回退策略。
