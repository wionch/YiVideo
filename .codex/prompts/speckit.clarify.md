---
description: 通过询问最多 5 个针对性极强的澄清问题来识别当前功能规范中未详尽的领域，并将答案编码回规范中。
handoffs:
    - label: 构建技术计划
      agent: speckit.plan
      prompt: 为该规范创建一个计划。我正在构建...
---

## 用户输入

```text
$ARGUMENTS

```

在继续之前（如果不为空），你**必须**考虑用户输入。

## 概要

目标：检测并减少活动功能规范中的歧义或缺失的决策点，并将澄清内容直接记录在规范文件中。

注意：此澄清工作流预计在调用 `/speckit.plan` 之前运行（并完成）。如果用户明确声明他们跳过澄清（例如，探索性 Spike），你可以继续，但必须警告下游返工风险会增加。

执行步骤：

1. 从仓库根目录运行 `.specify/scripts/bash/check-prerequisites.sh --json --paths-only` **一次**（组合 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小 JSON 负载字段：

-   `FEATURE_DIR`
-   `FEATURE_SPEC`
-   （可选捕获 `IMPL_PLAN`，`TASKS` 以用于未来的链式流。）
-   如果 JSON 解析失败，中止并指示用户重新运行 `/speckit.specify` 或验证功能上下文完整性。
-   对于像 "I'm Groot" 这样的参数中的单引号，请使用转义语法：例如 'I'''m Groot'（或者如果可能的话使用双引号："I'm Groot"）。

2. 加载当前规范文件。使用此分类法执行结构化歧义和覆盖率扫描。对于每个类别，标记状态：清晰 / 部分 / 缺失。生成用于优先排序的内部覆盖图（除非不询问任何问题，否则不要输出原始图）。
   功能范围和行为：

-   核心用户目标和成功标准
-   明确的范围外声明
-   用户角色 / 画像区分

领域和数据模型：

-   实体、属性、关系
-   身份和唯一性规则
-   生命周期 / 状态转换
-   数据量 / 规模假设

交互和用户体验流程：

-   关键用户旅程 / 序列
-   错误 / 空 / 加载状态
-   可访问性或本地化说明

非功能性质量属性：

-   性能（延迟、吞吐量目标）
-   可扩展性（水平/垂直、限制）
-   可靠性和可用性（正常运行时间、恢复期望）
-   可观测性（日志记录、指标、链路追踪信号）
-   安全和隐私（认证/授权、数据保护、威胁假设）
-   合规性 / 监管约束（如果有）

集成和外部依赖：

-   外部服务/API 和故障模式
-   数据导入/导出格式
-   协议/版本控制假设

边缘情况和故障处理：

-   负面场景
-   速率限制 / 节流
-   冲突解决（例如，并发编辑）

约束和权衡：

-   技术约束（语言、存储、托管）
-   明确的权衡或被拒绝的替代方案

术语和一致性：

-   规范词汇表术语
-   避免的同义词 / 弃用的术语

完成信号：

-   验收标准的可测试性
-   可衡量的“完成定义”风格指标

杂项 / 占位符：

-   TODO 标记 / 未解决的决策
-   缺乏量化的模糊形容词（“健壮”，“直观”）

对于状态为“部分”或“缺失”的每个类别，添加候选问题机会，除非：

-   澄清不会实质性地改变实施或验证策略
-   信息最好推迟到规划阶段（内部说明）

3. （在内部）生成优先排序的候选澄清问题队列（最多 5 个）。不要一次性全部输出。应用这些约束：

-   整个会话中最多总共 10 个问题。
-   每个问题必须可以通过以下任一方式回答：
-   简短的多项选择（2-5 个不同的、互斥的选项），或
-   一个单词 / 短语答案（明确限制：“用 <=5 个单词回答”）。

-   仅包含答案会实质性影响架构、数据建模、任务分解、测试设计、UX 行为、运营就绪性或合规性验证的问题。
-   确保类别覆盖平衡：尝试首先覆盖影响最大的未解决类别；避免在单个高影响领域（例如，安全态势）未解决时询问两个低影响问题。
-   排除已回答的问题、琐碎的风格偏好或计划级执行细节（除非阻碍正确性）。
-   倾向于能够减少下游返工风险或防止验收测试不一致的澄清。
-   如果仍有超过 5 个类别未解决，则通过（影响 * 不确定性）启发式方法选择前 5 个。

4. 顺序提问循环（交互式）：

-   每次**仅提出一个**问题。
-   对于多项选择题：
-   **分析所有选项**并根据以下内容确定**最合适的选项**：
-   项目类型的最佳实践
-   类似实现中的常见模式
-   风险降低（安全性、性能、可维护性）
-   与规范中可见的任何明确项目目标或约束的一致性

-   在顶部显着位置展示你的**推荐选项**，并附上清晰的理由（1-2 句话解释为什么这是最佳选择）。
-   格式为：`**推荐：** 选项 [X] - <理由>`
-   然后将所有选项渲染为 Markdown 表格：

| 选项 | 描述                                                                                         |
| ---- | -------------------------------------------------------------------------------------------- |
| A    | <选项 A 描述>                                                                                |
| B    | <选项 B 描述>                                                                                |
| C    | <选项 C 描述> (根据需要添加 D/E，最多 5 个)                                                  |
| 短语 | 提供不同的简短答案（<=5 个单词）（仅当自由形式的替代方案合适时包含）                         |

-   在表格之后，添加：`您可以回复选项字母（例如，“A”），说“是”或“推荐”来接受推荐，或者提供您自己的简短答案。`

-   对于简答题风格（没有有意义的离散选项）：
-   根据最佳实践和上下文提供你的**建议答案**。
-   格式为：`**建议：** <你提出的答案> - <简要理由>`
-   然后输出：`格式：简短答案（<=5 个单词）。您可以说“是”或“建议”来接受建议，或者提供您自己的答案。`

-   用户回答后：
-   如果用户回复“是”、“推荐”或“建议”，请使用你之前陈述的推荐/建议作为答案。
-   否则，验证答案是否映射到一个选项或符合 <=5 个单词的约束。
-   如果模棱两可，要求快速消除歧义（计数仍属于同一问题；不要推进）。
-   一旦满意，将其记录在工作记忆中（尚未写入磁盘）并移至下一个排队的问题。

-   当满足以下条件时停止提问：
-   所有关键歧义已提前解决（剩余的排队项目变得不必要），或
-   用户发出完成信号（“完成”、“好”、“不再有”），或
-   你达到了 5 个已提问题。

-   切勿提前透露未来的排队问题。
-   如果开始时不存在有效问题，请立即报告没有关键歧义。

5. 每次接受答案后的集成（增量更新方法）：

-   维护规范的内存表示（开始时加载一次）加上原始文件内容。
-   对于本次会话中的第一个集成答案：
-   确保存在 `## Clarifications` 部分（如果缺失，根据规范模板在最高级别的上下文/概述部分之后创建它）。
-   在其下，为今天创建（如果不存在）一个 `### Session YYYY-MM-DD` 子标题。

-   接受后立即附加一个要点行：`- Q: <问题> → A: <最终答案>`。
-   然后立即将澄清应用到最合适的部分：
-   功能歧义 → 更新或在功能需求中添加要点。
-   用户交互 / 参与者区分 → 更新用户故事或参与者子部分（如果存在），明确角色、约束或场景。
-   数据形状 / 实体 → 更新数据模型（添加字段、类型、关系）保留顺序；简洁地记录添加的约束。
-   非功能约束 → 在非功能 / 质量属性部分添加/修改可衡量标准（将模糊形容词转换为指标或明确目标）。
-   边缘情况 / 负面流程 → 在边缘情况 / 错误处理下添加新要点（或者如果模板为此提供了占位符，则创建此类子部分）。
-   术语冲突 → 规范内的术语标准化；仅在必要时通过添加 `(以前称为 "X")` 一次来保留原始术语。

-   如果澄清使较早的歧义陈述无效，请替换该陈述而不是重复；不要留下过时的矛盾文本。
-   每次集成后保存规范文件，以最大程度地降低上下文丢失的风险（原子覆盖）。
-   保留格式：不要重新排序不相关的部分；保持标题层次结构完整。
-   保持每个插入的澄清最小且可测试（避免叙述漂移）。

6. 验证（在每次写入加上最后一遍之后执行）：

-   澄清会话包含每个接受答案的一个要点（无重复）。
-   总提问（接受）问题数 ≤ 5。
-   更新的部分不包含新答案旨在解决的挥之不去的模糊占位符。
-   没有保留矛盾的早期陈述（扫描已删除的现已无效的替代选择）。
-   Markdown 结构有效；仅允许的新标题：`## Clarifications`, `### Session YYYY-MM-DD`。
-   术语一致性：在所有更新部分使用相同的规范术语。

7. 将更新后的规范写回 `FEATURE_SPEC`。
8. 报告完成（在提问循环结束或提前终止后）：

-   提问和回答的问题数量。
-   更新后的规范路径。
-   触及的部分（列出名称）。
-   覆盖率摘要表，列出每个分类法类别的状态：已解决（原为部分/缺失并已处理），推迟（超出问题配额或更适合规划），清晰（已经足够），未解决（仍为部分/缺失但影响较小）。
-   如果仍有任何未解决或推迟的项目，建议是继续进行 `/speckit.plan` 还是稍后在计划后再次运行 `/speckit.clarify`。
-   建议的下一个命令。

行为规则：

-   如果没有发现有意义的歧义（或者所有潜在问题都是低影响的），回复：“未检测到值得正式澄清的关键歧义。”并建议继续。
-   如果规范文件缺失，指示用户先运行 `/speckit.specify`（不要在这里创建新规范）。
-   总提问数切勿超过 5 个（针对单个问题的澄清重试不计为新问题）。
-   避免推测性的技术栈问题，除非缺失阻碍了功能清晰度。
-   尊重用户的提前终止信号（“停止”，“完成”，“继续”）。
-   如果由于全覆盖而没有提问，输出紧凑的覆盖率摘要（所有类别均为清晰），然后建议推进。
-   如果达到配额但仍有未解决的高影响类别，请在“推迟”下明确标记它们并说明理由。

优先排序的上下文：$ARGUMENTS