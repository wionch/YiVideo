# 目录使用重构设计文档

## 背景和约束

### 当前问题

1. **安全风险**: 临时文件使用系统级 `/tmp` 目录，存在权限和清理问题
2. **存储混乱**: 任务文件分散在 `share/single_tasks` 目录，命名不规范
3. **维护困难**: 缺乏统一的目录管理机制，影响维护和监控

### 设计约束

-   保持向后兼容性，不破坏现有工作流
-   最小化代码变更范围，专注路径修改
-   确保目录权限和安全隔离
-   保持高性能，避免影响现有功能

## 目标和非目标

### 目标

-   统一目录结构规范，提高可维护性
-   增强文件安全性和任务隔离
-   简化目录清理和监控机制
-   为未来扩展提供标准化的目录管理

### 非目标

-   修改业务逻辑或算法
-   改变 API 接口或数据格式
-   引入新的外部依赖
-   重构系统架构

## 技术决策

### 决策 1: 临时目录结构

**选择**: `/share/workflows/{task_id}/tmp/`
**理由**:

-   与任务管理逻辑一致，便于关联
-   提供天然的任务隔离
-   简化权限管理和清理流程
-   支持并发任务的无冲突执行

### 决策 2: 任务存储路径

**选择**: `/share/workflows/{task_id}/`
**理由**:

-   统一存储位置，便于管理
-   明确区分工作流任务和单任务
-   保持路径的可读性和可预测性
-   支持目录级别的权限控制

### 决策 3: 向后兼容策略

**选择**: 优先新路径，失败时回退到原路径
**理由**:

-   确保现有任务不受影响
-   允许渐进式迁移
-   减少部署风险
-   提供清理过渡期的灵活性

## 风险和权衡

### 主要风险

1. **路径更改导致的任务失败** - 缓解：通过严格测试和渐进部署
2. **权限问题** - 缓解：确保目录创建时设置正确权限
3. **磁盘空间使用增加** - 缓解：改进清理机制，及时回收临时文件

### 权衡考虑

-   **安全性 vs 便利性**: 选择更安全但稍微复杂的路径结构
-   **性能 vs 规范性**: 优先规范化，即使可能增加微小的路径构建开销
-   **兼容性 vs 简洁性**: 保持向后兼容性，但逐步淘汰旧路径

## 迁移计划

### 阶段 1: 代码更新

1. 修改核心函数中的路径生成逻辑
2. 更新配置文件和默认参数
3. 保持旧路径的支持和回退机制

### 阶段 2: 文档和配置

1. 更新技术文档中的路径示例
2. 修正配置文件中的默认设置
3. 更新开发指南和部署文档

### 阶段 3: 测试和验证

1. 运行单元测试确保功能正常
2. 执行集成测试验证工作流
3. 进行端到端测试确认整体功能

### 阶段 4: 部署和监控

1. 在开发环境部署和验证
2. 执行灰度部署到生产环境
3. 监控关键指标确保稳定性

## 清理计划

### 临时目录清理

-   任务完成后自动清理 `/share/workflows/{task_id}/tmp/`
-   定期扫描和清理孤立的任务目录
-   提供手动清理工具用于紧急情况

### 旧路径处理

-   迁移期保持对 `/share/single_tasks/` 的支持
-   监控旧路径的使用情况
-   在稳定期后可选择性清理旧目录

## 开放问题

1. **清理策略**: 是否需要在所有任务完成后立即清理 tmp 目录，还是保留一定时间用于调试？
2. **监控指标**: 需要添加哪些新的监控指标来跟踪目录使用情况？
3. **权限模型**: 是否需要为不同类型的任务设置不同的目录权限？
