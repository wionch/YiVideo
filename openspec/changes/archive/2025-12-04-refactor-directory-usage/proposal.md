# 变更：统一目录使用规范

## 背景

当前项目存在目录使用混乱的问题：

1. 临时文件使用系统级`/tmp`目录，存在安全性和管理问题
2. 任务相关文件存储在`share/single_tasks`目录，命名不够规范
3. 缺乏统一的目录结构管理机制

## 变更内容

### 1. 临时目录重构

-   **修改前**: 所有临时文件使用`/tmp`目录
-   **修改后**: 临时文件使用`任务id/tmp`格式，基于任务 ID 进行隔离

### 2. 任务存储目录统一

-   **修改前**: 使用`share/single_tasks`目录
-   **修改后**: 统一使用`share/workflows`目录

### 3. 影响的核心文件

-   `services/common/minio_directory_upload.py` - 压缩上传临时文件
-   `services/workers/faster_whisper_service/app/tasks.py` - 输出临时文件
-   `services/api_gateway/app/single_task_executor.py` - 任务上下文创建
-   `config.yml` - 临时目录配置
-   文档文件更新

## 影响评估

### 正面影响

-   提高文件安全性和隔离性
-   简化目录管理和清理
-   统一存储规范，降低维护成本
-   避免任务间文件冲突

### 风险评估

-   **低风险**: 主要涉及路径修改，不改变业务逻辑
-   **兼容性**: 需要确保现有工作流正常迁移
-   **测试**: 需要验证所有受影响的功能节点

## 实施策略

### 阶段 1：核心代码修改

1. 修改临时目录生成逻辑
2. 更新任务存储路径
3. 保持向后兼容性

### 阶段 2：配置和文档更新

1. 更新配置文件
2. 修正技术文档
3. 更新示例代码

### 阶段 3：验证和测试

1. 单元测试验证
2. 集成测试确认
3. 生产环境验证

## 回滚计划

如果出现问题，可以快速回滚：

1. 恢复原路径配置
2. 清理新增的目录结构
3. 重新部署原版本代码
