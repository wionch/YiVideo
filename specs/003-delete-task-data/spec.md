# 功能规范: 任务删除 API 节点

**功能分支**: `003-delete-task-data`
**创建时间**: 2025-12-22
**状态**: 草稿
**输入**: 用户描述: "功能: 添加删除任务功能节点 **节点文档**: @docs/technical/reference/SINGLE_TASK_API_REFERENCE.md 增加一个API请求节点.实现以下任务数据的**删除**功能: - 删除任务目录 - 删除redis数据 - 删除minio远程数据"

## 用户场景与测试 *(强制)*

### 用户故事 1 - 已完成任务释放空间 (优先级: P1)

运营/管理员在确认任务已完成后，通过单任务 API 发起删除请求，期望一次性清理本地目录、Redis 状态和 MinIO 文件，并得到清晰的删除结果。

**为什么是这个优先级**: 直接释放存储与缓存占用，避免资源堆积影响成本与后续任务复用。

**独立测试**: 仅创建并完成一个任务后调用删除 API，即可验证目录、Redis、MinIO 均被清空且响应反馈删除结果。

**验收场景**:

1. **Given** 任务已完成且资源存在, **When** 发送删除请求, **Then** 返回删除成功信息并确认本地目录、Redis、MinIO 均已清理。
2. **Given** 同一任务重复删除, **When** 再次调用删除, **Then** 返回幂等响应且不产生新错误。

---

### 用户故事 2 - 失败/脏数据清理 (优先级: P2)

当任务失败或输出不可信时，运营希望快速清除残留数据，避免错误结果被复用或占用存储。

**为什么是这个优先级**: 失败任务残留会导致复用错误与存储浪费，需及时清理。

**独立测试**: 制造失败任务后调用删除 API，确认所有目标资源被移除且后续状态查询不再返回旧数据。

**验收场景**:

1. **Given** 任务处于失败状态且存在部分输出, **When** 发送删除请求, **Then** 返回删除结果并移除 Redis 状态与远端/本地残留。

---

### 用户故事 3 - 无效任务请求保护 (优先级: P3)

调用方误传不存在的 task_id，希望得到友好提示且系统不做无谓操作。

**为什么是这个优先级**: 减少误操作成本，避免误删或无效调用占用资源。

**独立测试**: 对不存在的 task_id 调用删除 API，验证返回“未找到/无清理对象”提示且无副作用。

**验收场景**:

1. **Given** task_id 不存在, **When** 发送删除请求, **Then** 返回未找到提示且不对任何存储或状态进行修改。

---

### 边缘情况

- 任务处于运行中或排队中：默认安全模式拒绝删除并提示稍后重试；当请求明确传递 `force=true` 时允许强制删除并立即清理（需在响应中标记风险与实际清理结果）。
- 本地目录已被外部清理但 Redis/MinIO 仍在：删除应仍返回成功并标记目录已缺失。
- MinIO 暂时不可达或部分对象不存在：需要标记为部分失败并提示可重试清理。
- Redis 数据已过期或缺失：删除流程仍应完成并返回幂等结果。
- 重复调用同一 task_id：必须保持幂等，不产生额外错误或残留记录。
- 输入格式异常（task_id 为空/非法字符）：应拒绝并提示正确输入格式。

## 需求 *(强制)*

### 功能需求

- **FR-001**: 系统必须提供单任务删除 API（面向 task_id）以清理指定任务的本地目录、Redis 状态与 MinIO 远程文件，并返回统一结果。
- **FR-002**: 系统必须在删除前校验调用方具备与现有单任务接口一致的鉴权/权限要求，防止未授权删除。
- **FR-003**: 系统必须支持删除本地任务目录及其子目录，并防止路径遍历或越权访问非任务目录的文件。
- **FR-004**: 系统必须删除与 task_id 关联的 Redis 状态/缓存键，若键不存在也需视为删除成功并记录结果状态。
- **FR-005**: 系统必须删除 MinIO 中与 task_id 相关的远程对象（含目录/前缀），缺失对象不应导致整体失败但需在结果中标记。
- **FR-006**: 删除操作必须幂等；重复请求不得产生额外错误或残留，响应需标识每类资源的最终状态。
- **FR-007**: 删除响应必须可读且可测试，至少包含：整体删除状态、各资源类别（本地/Redis/MinIO）的结果、未完成项或重试建议。
- **FR-008**: 系统必须在检测到任务处于运行中/排队中时默认拒绝删除并提示稍后重试；当请求显式传递 `force=true` 时允许强制删除并立即清理，同时在响应中标记风险与实际处理结果。
- **FR-009**: 系统必须在异常（如 MinIO 不可用、目录权限不足）时继续执行可行的删除步骤，并返回部分成功的明细，避免出现静默失败。

### 关键实体 *(如果功能涉及数据则包括)*

- **TaskDeletionRequest**: 删除请求载荷，包含 task_id 以及（若支持）用户身份/权限信息；包含 `force` 标志（默认 false），仅当 `force=true` 时可对运行中/排队中的任务执行强制删除。
- **TaskDeletionResult**: 删除结果载体，按资源类别（本地目录、Redis、MinIO）提供状态、未完成项列表、可重试建议与时间戳。

## 成功标准 *(强制)*

### 可衡量结果

- **SC-001**: 95% 的删除请求在任务数据不超过 1GB 的情况下可在 5 秒内返回统一结果，调用方无需额外手动清理。
- **SC-002**: 对于已完成/失败任务，删除后再次查询状态/结果接口时不再返回任何该 task_id 的 Redis 数据或 MinIO 文件链接，本地目录不存在。
- **SC-003**: 对同一 task_id 重复发起 3 次删除请求，响应一致且无新增错误记录，验证幂等性达到 100%。
- **SC-004**: 遇到外部依赖不可用（如 MinIO 网络故障）时，响应能明确列出未删除项与重试指引，且不影响其他可删除资源的清理；相关异常信息可被审计追踪。

## 假设与备注

- 本规范未引用外部库文档（context7 未使用），成功标准基于常规 Web API 用户体验与存储清理期望，可在后续根据实际性能数据校准。
- 远程分支检测因远程 URL 异常未获取结果，编号基于本地 specs 最大值推算为 003。
