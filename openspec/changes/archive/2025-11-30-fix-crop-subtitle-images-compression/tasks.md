# 任务清单：修复 ffmpeg.crop_subtitle_images 压缩上传报错

## 完成状态
✅ **所有任务已完成**
**完成时间**: 2025-11-30 19:20

## 修复总结

本次修复解决了 ffmpeg.crop_subtitle_images 压缩上传功能的5个关键问题：

### 修复的问题
1. **变量名错误**: 修复 `format_enum` 和 `level_enum` 未定义错误
2. **枚举类型错误**: 修复对枚举对象调用 `.lower()` 方法的错误
3. **目录路径错误**: 添加智能路径解析，支持带/不带 frames 子目录
4. **文件模式匹配错误**: 修复逗号分隔的文件模式转换为列表
5. **错误处理机制**: 添加三层回退机制，确保压缩失败时自动回退

### 修改的文件
- `services/workers/ffmpeg_service/app/tasks.py`
- `services/common/minio_directory_upload.py`

### 测试结果
✅ 压缩上传功能正常工作
✅ 回退机制有效
✅ 向后兼容性保持

## 1. 问题诊断与代码分析
- [x] 1.1 检查 `services/workers/ffmpeg_service/app/tasks.py` 中 crop_subtitle_images 任务的图片存储路径逻辑
- [x] 1.2 检查 `services/common/minio_directory_upload.py` 中的压缩上传相关代码
- [x] 1.3 分析 `directory_compression.py` 的压缩实现
- [x] 1.4 确定所有受影响的代码文件和行号

## 2. 修复目录路径问题
- [x] 2.1 修改 `ffmpeg.crop_subtitle_images` 任务，正确识别图片实际存储路径
- [x] 2.2 添加路径验证逻辑，支持带/不带 frames 子目录的两种模式
- [x] 2.3 更新 `minio_directory_upload.py` 中的目录压缩逻辑
- [x] 2.4 确保路径拼接正确，无硬编码问题

## 3. 修复变量引用错误
- [x] 3.1 修复 `minio_directory_upload.py:514` 处的 `compression_format` 变量名错误
- [x] 3.2 确保压缩级别映射使用正确的参数值
- [x] 3.3 检查所有与压缩相关的变量引用，确保无遗漏

## 4. 完善错误处理机制
- [x] 4.1 修复压缩失败后的错误处理逻辑
- [x] 4.2 实现压缩失败时自动回退到非压缩上传模式
- [x] 4.3 添加详细的错误日志和状态记录
- [x] 4.4 确保任务状态与实际执行结果一致

## 5. 代码测试与验证
- [x] 5.1 创建单元测试 `tests/unit/services/workers/ffmpeg_service/test_crop_subtitle_images.py`
- [x] 5.2 创建集成测试验证压缩和非压缩两种模式
- [x] 5.3 测试不同目录结构情况
- [x] 5.4 测试错误回退机制
- [x] 5.5 运行所有相关测试，确保无回归

## 6. 手动测试验证
- [x] 6.1 使用提供的测试参数手动执行 ffmpeg.crop_subtitle_images 任务
- [x] 6.2 验证压缩上传成功，文件正确存储到 MinIO
- [x] 6.3 验证压缩失败时能正确回退到非压缩模式
- [x] 6.4 检查日志输出，确保无错误或警告信息

## 7. 文档和清理
- [x] 7.1 更新相关代码注释，说明修复的内容
- [x] 7.2 检查是否需要更新 API 文档
- [x] 7.3 清理临时文件和调试代码
- [x] 7.4 提交变更并推送代码

## 8. 部署前检查
- [x] 8.1 运行完整的测试套件
- [x] 8.2 确认不影响其他功能（特别是 ffmpeg.extract_keyframes）
- [x] 8.3 检查代码风格和质量（flake8, black）
- [x] 8.4 准备部署说明

## 实施优先级

### 高优先级（必须完成）
- 2.1, 2.2: 修复目录路径问题
- 3.1, 3.2: 修复变量引用错误
- 4.1, 4.2: 完善错误处理机制

### 中优先级（重要）
- 5.1-5.4: 创建测试
- 6.1-6.4: 手动测试验证

### 低优先级（可选）
- 7.1-7.4: 文档和清理
- 8.1-8.4: 部署前检查

## 预计完成时间
- **总计**: 2-3 天
- **关键路径**: 1 天（修复核心bug）
- **测试验证**: 1 天
- **文档和清理**: 0.5 天

## 依赖关系
- 无外部依赖
- 需要访问相关源代码文件
- 需要 MinIO 测试环境（可通过 Docker 提供）
