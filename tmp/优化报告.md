# YiVideo 工作流节点数据处理问题修复报告

## 问题分析

根据n8n工作流数据，发现以下关键问题：

### 1. input_params为空问题
**现象**: `"stages"."faster_whisper.transcribe_audio"."input_params"`为空字典`{}`

**根本原因**: 
- 所有服务工作流中都使用了相同的代码模式：
```python
workflow_context.stages[stage_name].input_params = resolved_params.copy() if resolved_params else {}
```
- 当没有显式节点参数时，`resolved_params`为空字典，导致`input_params`也为空字典
- 但实际执行过程中，任务会智能选择输入源（从前序任务输出或input_data中获取）

### 2. output中路径重复和数据冗余问题
**现象**: 
- `"segments_file"`和`"transcribe_data_file"`指向同一文件
- output中包含了输入参数`"audio_path"`

**根本原因**:
- Faster-Whisper服务输出中同时包含了文件路径引用和实际路径
- 输出结果混合了输入参数和执行结果，造成数据冗余

### 3. 标准化缺失
**问题**: 各服务工作流实现不一致，有些节点正确保存了input_params，有些则为空

## 修复策略

### 策略1: 修复input_params为空问题
**目标**: 确保每个阶段的input_params都包含实际使用的参数信息

**实现方案**:
1. 在参数解析后，将实际使用的输入参数记录到`input_params`
2. 包括智能选择的输入源信息
3. 添加音频源选择日志，便于调试

### 策略2: 清理output中的冗余数据
**目标**: 精简output，只保留必要的结果信息

**实现方案**:
1. 移除output中的输入参数（如audio_path等）
2. 统一文件路径字段，避免重复
3. 标准化输出格式

### 策略3: 统一所有服务工作流实现
**目标**: 确保所有节点遵循相同的数据处理标准

## 具体修复计划

### 阶段1: 修复Faster-Whisper服务
- 修复input_params记录逻辑
- 清理output中的冗余字段
- 统一文件路径字段

### 阶段2: 修复其他关键服务
- Audio Separator服务
- Pyannote Audio服务  
- FFmpeg服务
- PaddleOCR服务

### 阶段3: 修复WService
- 确保所有字幕处理节点遵循新标准

### 阶段4: 验证和测试
- 测试修复后的工作流
- 验证数据完整性
- 更新文档

## 预期效果

修复后，工作流数据将具有以下特性：

1. **input_params完整性**: 每个阶段都清楚记录使用的输入参数
2. **output精简性**: 只包含必要的输出结果，无冗余数据
3. **数据一致性**: 所有节点遵循统一的数据处理标准
4. **可调试性**: 清晰记录参数来源和选择逻辑

## 风险评估

- **低风险**: 修复主要涉及数据记录逻辑，不改变核心功能
- **兼容性**: 保持向后兼容，output格式调整不会影响依赖
- **测试**: 需要全面测试确保修复不影响现有工作流
