# å®æ–½ä»»åŠ¡æ¸…å•ï¼šå°† subprocess.run å‡çº§ä¸º subprocess.Popen

## âœ… Phase 1: æ ¸å¿ƒå·¥å…·å¼€å‘ï¼ˆå·²å®Œæˆï¼‰

-   [x] 1.1 åˆ›å»º `services/common/subprocess_utils.py` é€šç”¨å·¥å…·æ¨¡å—
-   [x] 1.2 å®ç° `run_with_popen` ä¸»å‡½æ•°ï¼Œæ”¯æŒå®æ—¶æ—¥å¿—è¾“å‡º
-   [x] 1.3 å®ç° `stream_output` çº¿ç¨‹å‡½æ•°ï¼Œå¤„ç† stdout/stderr æµå¼è¯»å–
-   [x] 1.4 å®ç° `SubprocessResult` å…¼å®¹æ€§ç»“æœç±»
-   [x] 1.5 å®ç° `run_gpu_command` GPU ä»»åŠ¡ä¸“ç”¨å‡½æ•°
-   [x] 1.6 æ·»åŠ ç±»å‹æç¤ºå’Œå®Œæ•´æ–‡æ¡£

**æˆæœ**: æˆåŠŸåˆ›å»º 228 è¡Œçš„é€šç”¨ subprocess.Popen å°è£…å·¥å…·ï¼Œå®Œå…¨å‘åå…¼å®¹

## âœ… Phase 2: æ ¸å¿ƒæœåŠ¡æ›´æ–°ï¼ˆå·²å®Œæˆï¼‰

-   [x] 2.1 æ›´æ–° `faster_whisper_service/app/tasks.py`

    -   [x] 2.1.1 æ›¿æ¢ `_execute_transcription` å‡½æ•°ä¸­çš„ `subprocess.run`
    -   [x] 2.1.2 ä¿æŒ CUDA ç¯å¢ƒå˜é‡ç»§æ‰¿
    -   [x] 2.1.3 ä¿æŒ 30 åˆ†é’Ÿè¶…æ—¶è®¾ç½®
    -   [x] 2.1.4 éªŒè¯è¯­éŸ³è½¬å½•ç»“æœä¸€è‡´æ€§

-   [x] 2.2 æ›´æ–° `paddleocr_service/app/tasks.py`

    -   [x] 2.2.1 æ›¿æ¢ `detect_subtitle_area` å‡½æ•°ä¸­çš„ `subprocess.run`
    -   [x] 2.2.2 æ›¿æ¢ `create_stitched_images` å‡½æ•°ä¸­çš„ `subprocess.run`
    -   [x] 2.2.3 æ›¿æ¢ `perform_ocr` å‡½æ•°ä¸­çš„ `subprocess.run`
    -   [x] 2.2.4 ä¿æŒ `check=True` å‚æ•°è¡Œä¸º

-   [x] 2.3 æ›´æ–° `ffmpeg_service/app/tasks.py`
    -   [x] 2.3.1 æ›¿æ¢ `extract_audio` å‡½æ•°ä¸­çš„ ffmpeg `subprocess.run`
    -   [x] 2.3.2 æ›¿æ¢ `crop_subtitle_images` å‡½æ•°ä¸­çš„ `subprocess.run`
    -   [x] 2.3.3 ä¿æŒ ffmpeg stderr è¾“å‡ºå¤„ç†é€»è¾‘

**æˆæœ**: é«˜ä¼˜å…ˆçº§æœåŠ¡å‡çº§å®Œæˆï¼Œæ¶‰åŠ 6 ä¸ª subprocess è°ƒç”¨

## âœ… Phase 3: è¾…åŠ©æœåŠ¡æ›´æ–°ï¼ˆå·²å®Œæˆï¼‰

-   [x] 3.1 æ›´æ–° `audio_separator_service/app/model_manager.py`

    -   [x] 3.1.1 æ›¿æ¢éŸ³é¢‘åˆ†ç¦»ä»»åŠ¡ä¸­çš„ `subprocess.run`
    -   [x] 3.1.2 ä¿æŒç¯å¢ƒå˜é‡å’Œç¼–ç è®¾ç½®

-   [x] 3.2 æ›´æ–° `pyannote_audio_service/app/tasks.py`
    -   [x] 3.2.1 æ›¿æ¢éŸ³é¢‘åˆ†æä»»åŠ¡ä¸­çš„ `subprocess.run`
    -   [x] 3.2.2 ä¿æŒæ‰§è¡Œæ—¶é—´ç»Ÿè®¡é€»è¾‘

**æˆæœ**: ä¸­ä¼˜å…ˆçº§æœåŠ¡å‡çº§å®Œæˆï¼Œæ¶‰åŠ 2 ä¸ª subprocess è°ƒç”¨

## âœ… Phase 4: å…¶ä»–æœåŠ¡æ›´æ–°ï¼ˆå·²å®Œæˆï¼‰

-   [x] 4.1 æ›´æ–° `ffmpeg_service/app/modules/audio_splitter.py`

    -   [x] 4.1.1 æ›¿æ¢éŸ³é¢‘åˆ†å‰²æ¨¡å—ä¸­çš„ `subprocess.run`
        -   [x] `_extract_segment` æ–¹æ³•ä¸­çš„ä¸»è¦ subprocess è°ƒç”¨
        -   [x] `_check_ffmpeg_availability` æ–¹æ³•ä¸­çš„ ffmpeg æ£€æŸ¥è°ƒç”¨

-   [x] 4.2 æ›´æ–° `wservice/app/tasks.py`
    -   [x] 4.2.1 **é‡è¦å‘ç°ï¼šwservice/app/tasks.py ä¸­æ—  subprocess è°ƒç”¨** - ä¸éœ€è¦ä¿®æ”¹

**æˆæœ**: ä½ä¼˜å…ˆçº§æœåŠ¡å‡çº§å®Œæˆï¼Œæ¶‰åŠ 2 ä¸ª subprocess è°ƒç”¨
**æ€»è®¡**: æ‰€æœ‰æ ¸å¿ƒæœåŠ¡çš„ 10 ä¸ª subprocess è°ƒç”¨å·²å…¨éƒ¨å‡çº§ä¸ºå®æ—¶æ—¥å¿—ç‰ˆæœ¬

## ğŸ› ç´§æ€¥ä¿®å¤ï¼šå¯¼å…¥é”™è¯¯ä¿®å¤ï¼ˆå·²å®Œæˆï¼‰

-   [x] ä¿®å¤ `services/workers/ffmpeg_service/app/modules/video_decoder.py`
    -   [x] ç§»é™¤å¯¹ä¸å­˜åœ¨æ¨¡å— `subprocess_manager` çš„å¼•ç”¨
    -   [x] æ¸…ç†æœªä½¿ç”¨çš„å¯¼å…¥å’Œå‡½æ•°ï¼ˆ`get_subprocess_manager_safe`, `run_command_with_manager`ï¼‰
    -   [x] ç¡®ä¿ ffmpeg_service å®¹å™¨å¯ä»¥æ­£å¸¸å¯åŠ¨

**æˆæœ**: è§£å†³äº†ç³»ç»Ÿé‡å¯å ffmpeg_service å®¹å™¨æ— æ³•å¯åŠ¨çš„ ModuleNotFoundError

## 5. æµ‹è¯•éªŒè¯

-   [ ] 5.1 ä¸º `subprocess_utils.py` åˆ›å»ºå•å…ƒæµ‹è¯•

    -   [ ] 5.1.1 æµ‹è¯•åŸºæœ¬åŠŸèƒ½
    -   [ ] 5.1.2 æµ‹è¯•è¶…æ—¶å¤„ç†
    -   [ ] 5.1.3 æµ‹è¯•é”™è¯¯å¤„ç†
    -   [ ] 5.1.4 æµ‹è¯•å®æ—¶æ—¥å¿—è¾“å‡º

-   [ ] 5.2 ä¸ºæ¯ä¸ªæ›´æ–°æœåŠ¡åˆ›å»ºé›†æˆæµ‹è¯•

    -   [ ] 5.2.1 æµ‹è¯•åŠŸèƒ½ç»“æœä¸€è‡´æ€§
    -   [ ] 5.2.2 æµ‹è¯•æ—¥å¿—è¾“å‡ºæ•ˆæœ
    -   [ ] 5.2.3 æµ‹è¯•é”™è¯¯å¤„ç†æ¢å¤

-   [ ] 5.3 ç«¯åˆ°ç«¯å·¥ä½œæµæµ‹è¯•
    -   [ ] 5.3.1 æµ‹è¯•å®Œæ•´è§†é¢‘å¤„ç†æµç¨‹
    -   [ ] 5.3.2 éªŒè¯å®æ—¶æ—¥å¿—æ˜¾ç¤º
    -   [ ] 5.3.3 æ€§èƒ½å¯¹æ¯”æµ‹è¯•

## 6. æ–‡æ¡£æ›´æ–°

-   [ ] 6.1 æ›´æ–° `docs/technical/reference/WORKFLOW_NODES_REFERENCE.md`

    -   [ ] 6.1.1 æ›´æ–°å„èŠ‚ç‚¹æ–‡æ¡£è¯´æ˜æ–°å¢çš„å®æ—¶æ—¥å¿—åŠŸèƒ½

-   [ ] 6.2 åˆ›å»º `docs/technical/subprocess-upgrade-guide.md` è¿ç§»æŒ‡å—

    -   [ ] 6.2.1 è¯´æ˜å‡çº§èƒŒæ™¯å’Œç›®æ ‡
    -   [ ] 6.2.2 æä¾›ä½¿ç”¨ç¤ºä¾‹
    -   [ ] 6.2.3 æ•…éšœæ’é™¤æŒ‡å—

-   [ ] 6.3 æ›´æ–°ç›¸å…³æœåŠ¡ README æ–‡æ¡£
    -   [ ] 6.3.1 æ›´æ–°æœåŠ¡ç‰¹æ€§è¯´æ˜
    -   [ ] 6.3.2 æ›´æ–°ç›‘æ§å’Œè°ƒè¯•æŒ‡å—

## 7. éªŒè¯å’Œéƒ¨ç½²

-   [ ] 7.1 è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
-   [ ] 7.2 æ€§èƒ½åŸºå‡†æµ‹è¯•
-   [ ] 7.3 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‡†å¤‡
-   [ ] 7.4 ç›‘æ§æŒ‡æ ‡è®¾ç½®

## å®æ–½æ³¨æ„äº‹é¡¹

### å…¼å®¹æ€§è¦æ±‚

-   ä¿æŒæ‰€æœ‰ç°æœ‰ API æ¥å£ä¸å˜
-   ä¿æŒæ‰§è¡Œç»“æœæ ¼å¼å®Œå…¨ä¸€è‡´
-   ä¿æŒé”™è¯¯å¤„ç†å’Œå¼‚å¸¸æŠ›å‡ºæœºåˆ¶
-   ä¿æŒæ—¥å¿—è®°å½•çš„è¯¦ç»†ç¨‹åº¦

### æ€§èƒ½è€ƒè™‘

-   çº¿ç¨‹å¼€é”€æ§åˆ¶åœ¨åˆç†èŒƒå›´å†…
-   æ—¥å¿—è¾“å‡ºé¢‘ç‡é€‚ä¸­ï¼Œé¿å…æ€§èƒ½å½±å“
-   å†…å­˜ä½¿ç”¨é‡æœ‰ä¸Šé™æ§åˆ¶
-   ç£ç›˜ I/O ä¼˜åŒ–

### å›æ»šç­–ç•¥

-   ä¿ç•™åŸå§‹ `subprocess.run` è°ƒç”¨ä½œä¸ºå¤‡ä»½
-   æä¾›é…ç½®å¼€å…³æ§åˆ¶æ˜¯å¦å¯ç”¨æ–°åŠŸèƒ½
-   ç¡®ä¿å¯ä»¥å¿«é€Ÿå›æ»šåˆ°åŸç‰ˆæœ¬
