# 语音转录服务参数管理统一规范

## ADDED Requirements

### Requirement: 统一音频源参数获取逻辑

语音转录任务**SHALL**使用统一的参数获取机制，通过 `get_param_with_fallback` 函数实现多级参数回退。

#### 当前实现（存在问题）
语音转录任务在 `faster_whisper_service/app/tasks.py` 中使用手动参数回退逻辑（第479-486行），存在以下问题：
- 代码重复，与其他服务不一致
- 不支持完整的单任务模式特性
- 维护复杂，难以扩展

#### 期望行为（统一后）
```python
# 统一的参数获取方式
audio_path = get_param_with_fallback(
    "audio_path", 
    resolved_params, 
    workflow_context,
    fallback_from_input_data=True,
    fallback_from_stage="faster_whisper.transcribe_audio"
)
```

#### 保持不变的行为
- 智能音频源选择的优先级逻辑：人声音频 → 默认音频 → 参数传入
- 音频文件验证和下载逻辑
- 语音转录核心功能和参数处理
- 输出数据结构和格式

#### Scenario: 单任务模式参数获取
- **WHEN** 通过 `/v1/tasks` 接口调用 `faster_whisper.transcribe_audio`
- **AND** 提供 `input_data.audio_path`
- **THEN** 系统应正确获取音频文件路径并执行转录
- **验证点**: 支持动态引用 `${{...}}` 语法

#### Scenario: 工作流模式参数回退
- **WHEN** 在工作流中调用 `faster_whisper.transcribe_audio`
- **AND** 未在节点参数中明确提供 `audio_path`
- **THEN** 系统应按优先级回退到上游节点输出：
  - 1. `audio_separator.separate_vocals` 输出的人声音频
  - 2. `ffmpeg.extract_audio` 输出的默认音频
- **验证点**: 智能源选择逻辑保持完全一致

#### Scenario: GPU锁模式兼容性
- **WHEN** 在CUDA模式下执行语音转录
- **AND** 使用统一的参数获取逻辑
- **THEN** GPU锁机制和参数获取应协调工作
- **验证点**: GPU资源管理和参数获取无冲突

#### Scenario: CPU模式兼容性
- **WHEN** 在CPU模式下执行语音转录
- **AND** 使用统一的参数获取逻辑
- **THEN** 参数获取和处理逻辑应正常执行
- **验证点**: 无GPU锁时的参数获取正确性

### Requirement: 兼容性保证

语音转录服务**MUST**保持与现有工作流配置的完全兼容性。

#### 兼容性要求
- ✅ 现有工作流配置无需修改
- ✅ API调用方式保持一致
- ✅ 智能音频源选择行为不变
- ✅ 输出数据格式完全兼容
- ✅ GPU锁和CPU模式切换正常

#### Scenario: 现有工作流兼容性
- **WHEN** 使用现有的工作流配置调用语音转录任务
- **AND** 包含音频分离和转录的完整链路
- **THEN** 系统应产生与重构前完全相同的结果
- **验证点**: 转录质量、性能和输出格式完全一致

#### Scenario: 词级时间戳功能
- **WHEN** 转录任务启用了词级时间戳功能
- **AND** 使用统一的参数获取方式
- **THEN** 词级时间戳的精度和完整性不受影响
- **验证点**: 时间戳数据结构和内容保持不变

#### Scenario: 错误处理和日志
- **WHEN** 参数获取失败或音频处理出错时
- **THEN** 应提供清晰的错误信息，包含音频源选择的调试信息
- **验证点**: 错误代码、消息和处理逻辑与重构前保持一致

## 测试要求

### 单元测试
- [ ] 参数获取逻辑的单元测试
- [ ] 单任务模式功能测试
- [ ] 工作流模式功能测试
- [ ] GPU锁模式测试
- [ ] CPU模式测试
- [ ] 错误处理测试

### 集成测试
- [ ] 与音频分离服务的集成测试
- [ ] 与FFmpeg服务的集成测试
- [ ] 与WService字幕生成的集成测试
- [ ] 完整语音转录工作流测试

### 性能测试
- [ ] 参数获取性能对比测试
- [ ] GPU/CPU模式性能测试
- [ ] 内存使用情况验证
- [ ] 转录质量和速度验证

## 验收标准

1. **功能完整性**: 所有现有功能正常工作，无功能回归
2. **参数一致性**: 所有音频源选择场景结果正确
3. **兼容性**: 现有配置和API调用无需修改
4. **性能**: GPU/CPU模式性能无显著影响（±5%范围内）
5. **代码质量**: 代码复用率高，无重复逻辑
6. **测试覆盖**: 单元测试覆盖率 ≥90%，集成测试全部通过

## 特殊考虑

### GPU资源管理
- 统一参数获取逻辑不应影响GPU锁的正常工作
- 需要验证在CUDA和CPU模式下的参数获取一致性

### 词级时间戳
- 确保词级时间戳功能的精度和完整性
- 验证时间戳数据的结构和内容不变

### 转录质量
- 保证重构不影响转录的准确性
- 验证模型参数和配置的正确传递