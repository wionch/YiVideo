# Phase 1 (P0) ä»£ç å®¡æŸ¥æ¸…å•

## ğŸ“‹ å˜æ›´æ¦‚è¿°

**ææ¡ˆ**: `fix-gpu-lock-deadlock-risks`
**é˜¶æ®µ**: Phase 1 (P0 - å…³é”®æ­»é”é£é™©ä¿®å¤)
**å®Œæˆæ—¥æœŸ**: 2025-12-24
**æµ‹è¯•çŠ¶æ€**: âœ… 28/28 æµ‹è¯•é€šè¿‡

---

## âœ… å®æ–½å®Œæˆæƒ…å†µ

### Task 1.1: å®ç° Lua è„šæœ¬åŸå­é”é‡Šæ”¾
- [x] å®šä¹‰ `RELEASE_LOCK_SCRIPT` Lua è„šæœ¬ï¼ˆlocks.py:49-58ï¼‰
- [x] é‡å†™ `release_lock` æ–¹æ³•ä½¿ç”¨ Lua è„šæœ¬ï¼ˆlocks.py:468-508ï¼‰
- [x] æ·»åŠ é”æ‰€æœ‰æƒéªŒè¯é€»è¾‘
- [x] å‘å¸ƒé”é‡Šæ”¾äº‹ä»¶åˆ° Pub/Sub
- [x] è®°å½•æ‰€æœ‰æƒéªŒè¯å¤±è´¥ç»Ÿè®¡

**éªŒè¯ç‚¹**:
- âœ… Lua è„šæœ¬ä½¿ç”¨ `redis.call("get")` å’Œ `redis.call("del")` åŸå­æ“ä½œ
- âœ… æ‰€æœ‰æƒéªŒè¯ï¼šåªæœ‰æŒæœ‰é”çš„ä»»åŠ¡æ‰èƒ½é‡Šæ”¾
- âœ… å¹¶å‘å®‰å…¨ï¼šå¤šçº¿ç¨‹åŒæ—¶é‡Šæ”¾ä¸ä¼šäº§ç”Ÿç«æ€æ¡ä»¶

### Task 1.2: ä¿®å¤ IndexTTS æœåŠ¡æ–¹æ³•è°ƒç”¨é”™è¯¯
- [x] ä¿®å¤ `IndexTTSTask.on_failure` æ–¹æ³•ï¼ˆtasks.py:51-67ï¼‰
- [x] å°† `force_release_lock()` æ”¹ä¸º `release_lock(task_name, lock_key, reason)`
- [x] æ·»åŠ å¼‚å¸¸å¤„ç†é˜²æ­¢é‡Šæ”¾å¤±è´¥å‘ä¸Šä¼ æ’­

**éªŒè¯ç‚¹**:
- âœ… ä¸å†æŠ›å‡º `AttributeError`ï¼ˆå›å½’æµ‹è¯•è¦†ç›–ï¼‰
- âœ… ä»»åŠ¡å¤±è´¥æ—¶æ­£ç¡®é‡Šæ”¾ GPU é”
- âœ… æ”¯æŒé»˜è®¤å’Œè‡ªå®šä¹‰ GPU ID

### Task 1.3: å¢å¼º Finally å—å¼‚å¸¸å¤„ç†
- [x] å®ç°ä¸‰å±‚ä¿æŠ¤æœºåˆ¶ï¼ˆlocks.py:749-782ï¼‰
  - ç¬¬ä¸€å±‚ï¼šGPU æ˜¾å­˜æ¸…ç†ï¼ˆç‹¬ç«‹å¼‚å¸¸æ•è·ï¼‰
  - ç¬¬äºŒå±‚ï¼šæ­£å¸¸é”é‡Šæ”¾ï¼ˆè®°å½•å¤±è´¥ç»Ÿè®¡ï¼‰
  - ç¬¬ä¸‰å±‚ï¼šåº”æ€¥å¼ºåˆ¶é‡Šæ”¾ï¼ˆRedis DELETE + å‘Šè­¦ï¼‰
- [x] æ·»åŠ  `send_alert` å‡½æ•°ï¼ˆlocks.py:888-897ï¼‰
- [x] æ·»åŠ  `record_critical_failure` å‡½æ•°ï¼ˆlocks.py:900-935ï¼‰
- [x] æ·»åŠ å¼‚å¸¸ç»Ÿè®¡å­—æ®µï¼ˆlocks.py:232-237ï¼‰

**éªŒè¯ç‚¹**:
- âœ… æ¯å±‚å¼‚å¸¸ç‹¬ç«‹æ•è·ï¼Œä¸å‘ä¸Šä¼ æ’­
- âœ… æ­£å¸¸é‡Šæ”¾å¤±è´¥æ—¶è§¦å‘åº”æ€¥é‡Šæ”¾
- âœ… å…³é”®å¤±è´¥è®°å½•åˆ°æŒä¹…åŒ–æ—¥å¿—
- âœ… å‘Šè­¦é€šè¿‡æ—¥å¿—ç³»ç»Ÿå‘é€

### Task 1.4: ç¼–å†™ Phase 1 å•å…ƒæµ‹è¯•
- [x] `test_gpu_lock_atomicity.py` - 7 ä¸ªæµ‹è¯•ç”¨ä¾‹
- [x] `test_indextts_error_handling.py` - 8 ä¸ªæµ‹è¯•ç”¨ä¾‹
- [x] `test_gpu_lock_error_handling.py` - 8 ä¸ªæµ‹è¯•ç”¨ä¾‹

**æµ‹è¯•è¦†ç›–**:
- âœ… Lua è„šæœ¬åŸå­æ€§å’Œæ‰€æœ‰æƒéªŒè¯
- âœ… å¹¶å‘é‡Šæ”¾æ— ç«æ€æ¡ä»¶
- âœ… IndexTTS é”™è¯¯å¤„ç†å’Œå›å½’æµ‹è¯•
- âœ… Finally å—ä¸‰å±‚ä¿æŠ¤æœºåˆ¶
- âœ… åº”æ€¥é‡Šæ”¾å’Œå…³é”®å¤±è´¥è®°å½•

### Task 1.5: ç¼–å†™ Phase 1 é›†æˆæµ‹è¯•
- [x] `test_gpu_lock_deadlock.py` - 5 ä¸ªæµ‹è¯•ç”¨ä¾‹

**æµ‹è¯•åœºæ™¯**:
- âœ… ä»»åŠ¡å´©æºƒæ—¶ä¸ä¼šå¯¼è‡´æ­»é”
- âœ… å¹¶å‘é”è·å–çš„äº’æ–¥æ€§å’Œé¡ºåºæ€§
- âœ… IndexTTS ä»»åŠ¡å¤±è´¥æ—¶çš„é”é‡Šæ”¾
- âœ… åº”æ€¥é‡Šæ”¾æœºåˆ¶çš„å®Œæ•´æµç¨‹
- âœ… é”è¶…æ—¶è‡ªåŠ¨è¿‡æœŸ

### Task 1.6: Phase 1 ä»£ç å®¡æŸ¥ä¸åˆå¹¶
- [x] è¿è¡Œæµ‹è¯•å¥—ä»¶ï¼š28/28 é€šè¿‡
- [x] ä¿®å¤ä»£ç è´¨é‡é—®é¢˜ï¼š
  - âœ… ä¿®å¤ locks.py:237 æ³¨é‡Šé”™è¯¯
  - âœ… ä¿®å¤ locks.py:503 å¼‚å¸¸ç±»å‹æ£€æŸ¥ï¼ˆä½¿ç”¨ `type(e).__name__`ï¼‰
- [x] å‡†å¤‡ä»£ç å®¡æŸ¥æ¸…å•ï¼ˆæœ¬æ–‡ä»¶ï¼‰

---

## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥

### 1. åŠŸèƒ½æ­£ç¡®æ€§
- [x] æ‰€æœ‰ P0 ä»»åŠ¡å·²å®ç°
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ28/28ï¼‰
- [x] æ— å·²çŸ¥åŠŸèƒ½ç¼ºé™·

### 2. å‘åå…¼å®¹æ€§
- [x] `release_lock` æ–¹æ³•ç­¾åä¿æŒå…¼å®¹
- [x] ç°æœ‰è°ƒç”¨ä»£ç æ— éœ€ä¿®æ”¹
- [x] è£…é¥°å™¨ `@gpu_lock` è¡Œä¸ºä¸å˜

### 3. å¼‚å¸¸å¤„ç†
- [x] æ‰€æœ‰å¼‚å¸¸è¢«æ­£ç¡®æ•è·
- [x] å¼‚å¸¸ä¸ä¼šå¯¼è‡´æ­»é”
- [x] å…³é”®å¤±è´¥æœ‰æŒä¹…åŒ–è®°å½•

### 4. æ—¥å¿—å’Œç›‘æ§
- [x] æ‰€æœ‰å…³é”®æ“ä½œæœ‰æ—¥å¿—è®°å½•
- [x] å¼‚å¸¸ç»Ÿè®¡å­—æ®µå®Œæ•´
- [x] å‘Šè­¦æœºåˆ¶å·²å®ç°ï¼ˆå½“å‰ä¸ºæ—¥å¿—ï¼‰

### 5. ä»£ç é£æ ¼
- [x] éµå¾ª Python 3.11+ ç±»å‹æ³¨è§£
- [x] å‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²å®Œæ•´
- [x] æ³¨é‡Šæ¸…æ™°å‡†ç¡®

---

## ğŸ“Š æµ‹è¯•ç»“æœæ‘˜è¦

```
============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
plugins: anyio-4.11.0
collected 28 items

tests/unit/test_gpu_lock_atomicity.py .......                            [ 25%]
tests/unit/test_indextts_error_handling.py ........                      [ 53%]
tests/unit/test_gpu_lock_error_handling.py ........                      [ 82%]
tests/integration/test_gpu_lock_deadlock.py .....                        [100%]

======================== 28 passed, 1 warning in 8.64s =========================
```

**è­¦å‘Š**: Pydantic V2 è¿ç§»è­¦å‘Šï¼ˆéé˜»å¡ï¼Œå·²çŸ¥é—®é¢˜ï¼‰

---

## ğŸ¯ å®¡æŸ¥è¦ç‚¹

### å…³é”®å˜æ›´æ–‡ä»¶
1. **services/common/locks.py**
   - æ–°å¢ Lua è„šæœ¬å¸¸é‡ï¼ˆ49-58 è¡Œï¼‰
   - ä¿®æ”¹ `SmartGpuLockManager.__init__`ï¼ˆ232-237 è¡Œï¼‰
   - é‡å†™ `release_lock` æ–¹æ³•ï¼ˆ468-508 è¡Œï¼‰
   - å¢å¼º `@gpu_lock` è£…é¥°å™¨ finally å—ï¼ˆ749-782 è¡Œï¼‰
   - æ–°å¢ `send_alert` å’Œ `record_critical_failure` å‡½æ•°ï¼ˆ888-935 è¡Œï¼‰

2. **services/workers/indextts_service/app/tasks.py**
   - ä¿®å¤ `IndexTTSTask.on_failure` æ–¹æ³•ï¼ˆ51-67 è¡Œï¼‰

### æµ‹è¯•æ–‡ä»¶
3. **tests/unit/test_gpu_lock_atomicity.py** - 7 ä¸ªæµ‹è¯•
4. **tests/unit/test_indextts_error_handling.py** - 8 ä¸ªæµ‹è¯•
5. **tests/unit/test_gpu_lock_error_handling.py** - 8 ä¸ªæµ‹è¯•
6. **tests/integration/test_gpu_lock_deadlock.py** - 5 ä¸ªæµ‹è¯•

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **å‘Šè­¦ç³»ç»Ÿ**: å½“å‰ä»…è®°å½•æ—¥å¿—ï¼Œæœªé›†æˆé‚®ä»¶/Slack/é’‰é’‰ï¼ˆPhase 3 ä»»åŠ¡ï¼‰
2. **å…³é”®å¤±è´¥æ—¥å¿—**: å†™å…¥æœ¬åœ°æ–‡ä»¶ `/var/log/yivideo/gpu_lock_critical_failures.log`ï¼Œéœ€ç¡®ä¿ç›®å½•æƒé™
3. **å¼‚å¸¸ç±»å‹æ£€æŸ¥**: ä½¿ç”¨ `type(e).__name__` è€Œé `isinstance`ï¼Œå› æœªå¯¼å…¥ `redis.exceptions`

---

## ğŸ“ åç»­å·¥ä½œ

### Phase 2 (P1) - ç›‘æ§ä¸ä¼˜åŒ–
- Task 2.1: å®ç° Prometheus æŒ‡æ ‡å¯¼å‡º
- Task 2.2: ä¼˜åŒ–é”è¶…æ—¶å‚æ•°
- Task 2.3: å®ç°å¿ƒè·³æœºåˆ¶

### Phase 3 (P2) - å¥åº·æ£€æŸ¥ä¸å‘Šè­¦
- Task 3.1: å®ç°å¥åº·æ£€æŸ¥ API
- Task 3.2: é›†æˆå‘Šè­¦é€šçŸ¥æ¸ é“
- Task 3.3: å®ç°è‡ªåŠ¨æ¢å¤æœºåˆ¶

---

## âœ… å®¡æŸ¥æ‰¹å‡†

**å®¡æŸ¥äºº**: _____________
**å®¡æŸ¥æ—¥æœŸ**: _____________
**æ‰¹å‡†çŠ¶æ€**: [ ] æ‰¹å‡†åˆå¹¶ [ ] éœ€è¦ä¿®æ”¹

**å¤‡æ³¨**:
