# YiVideo 工作流节点参数定义收集报告

## 收集时间

2025-12-02T05:44:00Z

## 收集范围

基于对 YiVideo 系统代码实现的详细扫描，收集了所有工作流节点的完整参数定义。

## 参数定义汇总

### 1. FFmpeg 服务 (4 个节点)

#### 1.1 extract_keyframes 节点

**服务**: `services/workers/ffmpeg_service/app/tasks.py:41`

**输入参数**:

-   `video_path`: 视频文件路径 (必需)
-   `keyframe_sample_count`: 抽取帧数，默认 100
-   `upload_keyframes_to_minio`: 是否上传到 MinIO，默认 false
-   `delete_local_keyframes_after_upload`: 上传后删除本地文件，默认 false
-   `compress_keyframes_before_upload`: 是否压缩后上传，默认 false
-   `keyframe_compression_format`: 压缩格式，默认"zip"
-   `keyframe_compression_level`: 压缩级别，默认"default"

**输出格式**:

```json
{
    "keyframe_dir": "本地关键帧目录",
    "keyframe_minio_url": "MinIO URL（可选）",
    "keyframe_compressed_archive_url": "压缩包URL（可选）",
    "keyframe_files_count": "文件数量",
    "keyframe_compression_info": "压缩信息（可选）",
    "keyframe_upload_error": "错误信息（可选）"
}
```

#### 1.2 extract_audio 节点

**服务**: `services/workers/ffmpeg_service/app/tasks.py:276`

**输入参数**:

-   `video_path`: 视频文件路径 (必需)

**输出格式**:

```json
{
    "audio_path": "音频文件路径"
}
```

#### 1.3 crop_subtitle_images 节点

**服务**: `services/workers/ffmpeg_service/app/tasks.py:427`

**输入参数**:

-   `video_path`: 视频文件路径 (必需)
-   `subtitle_area`: 字幕区域坐标 (必需，从上游节点获取或直接传入)
-   `upload_cropped_images_to_minio`: 是否上传到 MinIO，默认 false
-   `delete_local_cropped_images_after_upload`: 上传后删除本地文件，默认 false
-   `compress_directory_before_upload`: 是否压缩后上传，默认 false
-   `compression_format`: 压缩格式，默认"zip"
-   `compression_level`: 压缩级别，默认"default"
-   `decode_processes`: 解码进程数，默认 10

**输出格式**:

```json
{
    "cropped_images_path": "裁剪图片目录路径",
    "cropped_images_minio_url": "MinIO URL（可选）",
    "compressed_archive_url": "压缩包URL（可选）",
    "cropped_images_files_count": "文件数量",
    "compression_info": "压缩信息（可选）",
    "cropped_images_upload_error": "错误信息（可选）",
    "fallback_from_compression": "是否回退上传（可选）"
}
```

#### 1.4 split_audio_segments 节点

**服务**: `services/workers/ffmpeg_service/app/tasks.py:757`

**输入参数**:

-   `audio_path`: 音频文件路径 (必需)
-   `subtitle_path`: 字幕文件路径 (必需)
-   `output_format`: 输出格式，默认"wav"
-   `sample_rate`: 采样率，默认 16000
-   `channels`: 声道数，默认 1
-   `min_segment_duration`: 最小片段时长，默认 1.0 秒
-   `max_segment_duration`: 最大片段时长，默认 30.0 秒
-   `group_by_speaker`: 按说话人分组，默认 false
-   `include_silence`: 包含静音，默认 false
-   `enable_concurrent`: 并发分割，默认 true
-   `max_workers`: 最大工作线程数，默认 8
-   `concurrent_timeout`: 并发超时，默认 600 秒

**输出格式**:

```json
{
    "audio_segments_dir": "音频片段目录",
    "audio_source": "音频源路径",
    "subtitle_source": "字幕源路径",
    "total_segments": "总片段数",
    "successful_segments": "成功片段数",
    "failed_segments": "失败片段数",
    "total_duration": "总时长",
    "processing_time": "处理时间",
    "audio_format": "音频格式",
    "sample_rate": "采样率",
    "channels": "声道数",
    "split_info_file": "分割信息文件",
    "segments_count": "片段数量",
    "speaker_summary": "说话人摘要（可选）"
}
```

### 2. Faster-Whisper 服务 (1 个节点)

#### 2.1 transcribe_audio 节点

**服务**: `services/workers/faster_whisper_service/app/tasks.py:419`

**输入参数**:

-   `audio_path`: 音频文件路径 (必需)
-   `model_name`: 模型名称，默认"large-v3"
-   `device`: 设备类型，默认"cuda"
-   `compute_type`: 计算类型，默认"float16"
-   `language`: 语言，None(自动检测)
-   `beam_size`: 束搜索大小，默认 3
-   `best_of`: 候选数，默认 3
-   `temperature`: 温度，默认[0.0, 0.2, 0.4, 0.6]
-   `word_timestamps`: 词级时间戳，默认 True
-   `vad_filter`: 语音活动检测，默认 False
-   `vad_parameters`: VAD 参数，None

**输出格式**:

```json
{
    "segments_file": "转录数据文件路径",
    "audio_duration": "音频时长",
    "language": "检测语言",
    "transcribe_duration": "转录耗时",
    "model_name": "使用的模型",
    "device": "设备类型",
    "enable_word_timestamps": "是否启用词级时间戳",
    "statistics": "统计信息",
    "segments_count": "片段数量"
}
```

### 3. WService 字幕优化服务 (6 个节点)

#### 3.1 generate_subtitle_files 节点

**服务**: `services/workers/wservice/app/tasks.py:492`

**输入参数**: (无特定参数，从 faster_whisper 和 pyannote_audio 阶段获取)

**输出格式**:

```json
{
    "subtitle_path": "基础字幕文件路径",
    "subtitle_files": {
        "basic": "基础字幕文件路径",
        "with_speakers": "带说话人信息字幕文件路径（可选）",
        "word_timestamps": "词级时间戳JSON文件路径（可选）"
    }
}
```

#### 3.2 merge_speaker_segments 节点

**服务**: `services/workers/wservice/app/tasks.py:608`

**输入参数**:

-   `segments_data`: 转录片段数据 (可选)
-   `speaker_segments_data`: 说话人片段数据 (可选)
-   `segments_file`: 转录数据文件路径 (可选)
-   `diarization_file`: 说话人分离数据文件路径 (可选)

**输出格式**:

```json
{
    "merged_segments": "合并后的片段列表",
    "input_summary": {
        "transcript_segments_count": "转录片段数",
        "speaker_segments_count": "说话人片段数",
        "merged_segments_count": "合并片段数",
        "data_source": "数据源描述"
    }
}
```

#### 3.3 merge_with_word_timestamps 节点

**服务**: `services/workers/wservice/app/tasks.py:718`

**输入参数**:

-   `segments_data`: 包含词级时间戳的转录片段数据 (可选)
-   `speaker_segments_data`: 说话人片段数据 (可选)
-   `segments_file`: 包含词级时间戳的转录数据文件路径 (可选)
-   `diarization_file`: 说话人分离数据文件路径 (可选)

**输出格式**:

```json
{
    "merged_segments": "合并后的片段列表",
    "input_summary": {
        "transcript_segments_count": "转录片段数",
        "speaker_segments_count": "说话人片段数",
        "merged_segments_count": "合并片段数",
        "data_source": "数据源描述",
        "word_timestamps_required": true
    }
}
```

#### 3.4 correct_subtitles 节点

**服务**: `services/workers/wservice/app/tasks.py:834`

**输入参数**:

-   `subtitle_path`: 字幕文件路径 (可选，从上游节点获取)
-   `subtitle_correction`: 字幕校正配置

**输出格式**:

```json
{
    "corrected_subtitle_path": "校正后字幕文件路径",
    "original_subtitle_path": "原始字幕文件路径",
    "provider_used": "使用的AI提供商",
    "statistics": "校正统计信息"
}
```

#### 3.5 ai_optimize_subtitles 节点

**服务**: `services/workers/wservice/app/tasks.py:931`

**输入参数**:

-   `subtitle_optimization`: 字幕优化配置
-   `segments_file`: 转录数据文件路径 (可选)

**输出格式**:

```json
{
    "optimized_file_path": "优化后文件路径",
    "original_file_path": "原始文件路径",
    "provider_used": "使用的AI提供商",
    "processing_time": "处理时间",
    "subtitles_count": "字幕数量",
    "commands_applied": "应用的命令数",
    "batch_mode": "是否批处理模式",
    "batches_count": "批次数",
    "statistics": "统计信息"
}
```

#### 3.6 prepare_tts_segments 节点

**服务**: `services/workers/wservice/app/tasks.py:1133`

**输入参数**:

-   `segments_data`: 字幕片段数据 (可选)
-   `segments_file`: 字幕片段数据文件路径 (可选)
-   `source_stage_names`: 自定义源阶段名称列表 (可选)

**输出格式**:

```json
{
    "prepared_segments": "准备好的片段列表",
    "source_stage": "源阶段名称",
    "total_segments": "总片段数",
    "input_summary": {
        "original_segments_count": "原始片段数",
        "prepared_segments_count": "准备片段数",
        "data_source": "数据源描述"
    }
}
```

## 共通模式分析

### 参数解析模式

所有节点都遵循统一的参数解析模式：

```python
node_params = workflow_context.input_params.get('node_params', {}).get(stage_name, {})
resolved_params = resolve_parameters(node_params, workflow_context.model_dump())
```

### 统一参数获取函数

使用 `get_param_with_fallback()` 函数进行统一的参数获取：

-   支持优先级参数获取
-   支持动态引用解析 (`${{...}}`)
-   支持工作流上下文回退
-   支持单任务模式

### 智能源选择逻辑

多个节点实现了智能源选择机制：

-   优先级选择逻辑：参数 > 文件路径 > 工作流阶段输出
-   支持 fallback 机制
-   详细的数据源记录

### 输出数据优化

所有节点的输出都进行了精简优化：

-   避免 Redis 存储冗余数据
-   通过文件引用提供详细信息
-   提供摘要信息用于快速统计

## 参数验证发现

### 发现的潜在不一致性

1. **参数名称变化**: 部分文档中描述的参数名称与代码实际使用的参数名称存在差异
2. **默认值变化**: 某些参数的默认值在代码实现中进行了优化调整
3. **新增参数**: 代码实现中添加了一些文档中未提及的新参数
4. **参数类型**: 部分参数的类型和约束条件需要进一步核实

### 需要验证的区域

1. **Pyannote Audio 服务参数**: 尚未完整收集
2. **PaddleOCR 服务参数**: 尚未完整收集
3. **Audio Separator 服务参数**: 尚未完整收集
4. **IndexTTS 服务参数**: 尚未完整收集

---

**报告状态**: 部分完成 (3/7 服务已完成)
**下一步**: 继续收集剩余服务的参数定义
