# YiVideo å‚æ•°ç»Ÿä¸€ç®¡ç†é‡æ„æ–½å·¥æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.3 (Final)
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-22
> **æœ€åä¿®è®¢**: 2025-11-22
> **çŠ¶æ€**: âœ… å·²å…¨éƒ¨å®Œæˆ
> **ä¼˜å…ˆçº§**: P0 - ç´§æ€¥ï¼ˆä¿®å¤å½“å‰ç”Ÿäº§ç¯å¢ƒbugï¼‰

---

## ğŸ“‹ ç›®å½•

- [ä¸€ã€é—®é¢˜èƒŒæ™¯](#ä¸€é—®é¢˜èƒŒæ™¯)
- [äºŒã€é—®é¢˜åˆ†æ](#äºŒé—®é¢˜åˆ†æ)
- [ä¸‰ã€è§£å†³æ–¹æ¡ˆè®¾è®¡](#ä¸‰è§£å†³æ–¹æ¡ˆè®¾è®¡)
- [å››ã€åŠŸèƒ½èŠ‚ç‚¹æ£€æŸ¥æ¸…å•](#å››åŠŸèƒ½èŠ‚ç‚¹æ£€æŸ¥æ¸…å•)
- [äº”ã€è¯¦ç»†æ–½å·¥TodoList](#äº”è¯¦ç»†æ–½å·¥todolist)
- [å…­ã€é£é™©è¯„ä¼°ä¸ç¼“è§£](#å…­é£é™©è¯„ä¼°ä¸ç¼“è§£)
- [ä¸ƒã€æ—¶é—´é¢„ä¼°](#ä¸ƒæ—¶é—´é¢„ä¼°)

---

## ä¸€ã€é—®é¢˜èƒŒæ™¯

### 1.1 å½“å‰é—®é¢˜

**ç”Ÿäº§ç¯å¢ƒæŠ¥é”™**ï¼šåœ¨ä½¿ç”¨n8nè°ƒç”¨å•ä»»åŠ¡APIæ—¶ï¼Œ`ffmpeg.crop_subtitle_images` ä»»åŠ¡æŠ¥é”™ï¼š

```
ValueError: ç¼ºå°‘å­—å¹•åŒºåŸŸåæ ‡ä¿¡æ¯ï¼šè¯·é€šè¿‡ 'subtitle_area' å‚æ•°ä¼ å…¥ï¼Œ
æˆ–ç¡®ä¿ paddleocr.detect_subtitle_area èŠ‚ç‚¹å·²æˆåŠŸå®Œæˆå¹¶è¾“å‡ºäº†å­—å¹•åŒºåŸŸæ•°æ®ã€‚
```

**n8nè¯·æ±‚ç¤ºä¾‹**ï¼š
```json
{
  "task_name": "ffmpeg.crop_subtitle_images",
  "task_id": "task_id",
  "callback": "{{ $execution.resumeUrl }}/t3",
  "input_data": {
    "video_path": "http://host.docker.internal:9000/yivideo/task_id/223.mp4",
    "subtitle_area": [0, 607, 1280, 679],
    "upload_cropped_images_to_minio": true
  }
}
```

**é—®é¢˜åŸå› **ï¼šè™½ç„¶è¯·æ±‚ä¸­æä¾›äº† `subtitle_area` å‚æ•°ï¼Œä½†ä»»åŠ¡ä»£ç åªä» `resolved_params` å’Œä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡ºè¯»å–ï¼Œç¼ºå°‘ä» `input_data` çš„å›é€€é€»è¾‘ã€‚

### 1.2 æ ¹æœ¬åŸå› 

ç»è¿‡å…¨é¢åˆ†æï¼Œå‘ç°**è¿™æ˜¯ä¸€ä¸ªæ™®éæ€§é—®é¢˜**ï¼š

1. **å®ç°ä¸ä¸€è‡´**ï¼šä¸åŒèŠ‚ç‚¹å¯¹å‚æ•°è·å–çš„å®ç°å„ä¸ç›¸åŒ
2. **ç¼ºå°‘ç»Ÿä¸€æ ‡å‡†**ï¼šæ²¡æœ‰ç»Ÿä¸€çš„å‚æ•°è·å–å·¥å…·
3. **å½±å“èŒƒå›´å¹¿**ï¼šå½±å“å¤šä¸ªworkeræœåŠ¡çš„å¤šä¸ªèŠ‚ç‚¹

---

## äºŒã€é—®é¢˜åˆ†æ

### 2.1 å‚æ•°æ¥æºä¸‰ç§ä½ç½®

| # | æ¥æºä½ç½® | ä½¿ç”¨åœºæ™¯ | è·¯å¾„ç¤ºä¾‹ |
|---|---------|---------|---------|
| 1 | **node_params** | å·¥ä½œæµæ¨¡å¼ | `input_params.node_params.{stage_name}.xxx` |
| 2 | **input_data** | å•ä»»åŠ¡æ¨¡å¼ | `input_params.input_data.xxx` |
| 3 | **ä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡º** | ä»£ç å›é€€ | `stages.{stage_name}.output.xxx` |

### 2.2 å‚æ•°å€¼ä¸¤ç§æ ¼å¼

| ç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|
| **é™æ€å€¼** | `[0, 607, 1280, 679]` | ç›´æ¥ä½¿ç”¨ |
| **åŠ¨æ€å¼•ç”¨** | `${{stages.xxx.output.yyy}}` | éœ€è¦é€šè¿‡ `resolve_parameters()` è§£æ |

### 2.3 æ­£ç¡®çš„å‚æ•°è·å–ä¼˜å…ˆçº§

```
node_params (å·²è§£æ) > input_data (æ”¯æŒåŠ¨æ€è§£æ) > ä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡º > é»˜è®¤å€¼
```

### 2.4 ç°æœ‰å®ç°é—®é¢˜æ€»ç»“

| èŠ‚ç‚¹æœåŠ¡ | å®ç°æ–¹å¼ | é—®é¢˜ä¸¥é‡ç¨‹åº¦ |
|---------|----------|------------|
| **audio_separator_service** | âœ… æœ‰å®Œæ•´å›é€€é€»è¾‘ | æ— é—®é¢˜ï¼ˆç¤ºä¾‹ï¼‰ |
| **ffmpeg_service** | âš ï¸ éƒ¨åˆ†å‚æ•°æœ‰å›é€€ï¼Œéƒ¨åˆ†æ²¡æœ‰ | ä¸­-é«˜ |
| **faster_whisper_service** | âŒ ç¼ºå°‘å›é€€é€»è¾‘ | ä¸­ |
| **paddleocr_service** | âš ï¸ æ··åˆå®ç° | ä¸­ |
| **wservice** | ğŸ” å¾…æ£€æŸ¥ | å¾…å®š |

---

## ä¸‰ã€è§£å†³æ–¹æ¡ˆè®¾è®¡

### 3.1 æ ¸å¿ƒç­–ç•¥ï¼šç»Ÿä¸€å‚æ•°è·å–å‡½æ•°

åœ¨ `services/common/parameter_resolver.py` ä¸­æ·»åŠ æ–°å‡½æ•° `get_param_with_fallback()`ï¼Œæä¾›ç»Ÿä¸€çš„å‚æ•°è·å–æ¥å£ã€‚

### 3.2 å‡½æ•°å®Œæ•´ä»£ç 

```python
# services/common/parameter_resolver.py
# åœ¨ç°æœ‰ä»£ç åŸºç¡€ä¸Šæ·»åŠ ä»¥ä¸‹å‡½æ•°

from typing import Any, Dict, Optional, Union
from services.common.context import WorkflowContext

def get_param_with_fallback(
    param_name: str,
    resolved_params: Dict[str, Any],
    workflow_context: Union[WorkflowContext, Dict[str, Any]],
    default: Any = None,
    fallback_from_input_data: bool = True,
    fallback_from_stage: Optional[str] = None,
    fallback_field: Optional[str] = None,
    allow_dynamic_resolution: bool = True
) -> Any:
    """
    æ™ºèƒ½å‚æ•°è·å–å·¥å…·ï¼Œç»Ÿä¸€æ”¯æŒä¸‰ç§å‚æ•°æ¥æºçš„è·å–

    å‚æ•°è·å–ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
    1. node_paramsï¼ˆå·²é€šè¿‡ resolve_parameters è§£æçš„å‚æ•°ï¼‰
    2. input_dataï¼ˆæ”¯æŒåŠ¨æ€å¼•ç”¨ ${{}} è§£æï¼‰
    3. æŒ‡å®šçš„å‰ç½®é˜¶æ®µè¾“å‡ºï¼ˆä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡ºï¼‰
    4. é»˜è®¤å€¼

    æ”¯æŒåœºæ™¯ï¼š
    âœ… å·¥ä½œæµæ¨¡å¼ - node_params + åŠ¨æ€å¼•ç”¨
    âœ… å•ä»»åŠ¡æ¨¡å¼ - input_dataï¼ˆé™æ€å€¼ï¼‰
    âœ… å•ä»»åŠ¡æ¨¡å¼ - input_dataï¼ˆåŠ¨æ€å¼•ç”¨ï¼‰
    âœ… ä¸Šæ¸¸èŠ‚ç‚¹è‡ªåŠ¨è·å–

    Args:
        param_name: å‚æ•°åç§°
        resolved_params: å·²è§£æçš„èŠ‚ç‚¹å‚æ•°å­—å…¸ï¼ˆæ¥è‡ª node_paramsï¼Œå·²ç»è¿‡ resolve_parameters å¤„ç†ï¼‰
        workflow_context: å·¥ä½œæµä¸Šä¸‹æ–‡å¯¹è±¡æˆ–å­—å…¸
        default: é»˜è®¤å€¼
        fallback_from_input_data: æ˜¯å¦ä» input_data å›é€€ï¼ˆé»˜è®¤ Trueï¼‰
        fallback_from_stage: å¯é€‰çš„å‰ç½®é˜¶æ®µåç§°ï¼ˆå¦‚ "paddleocr.detect_subtitle_area"ï¼‰
        fallback_field: å‰ç½®é˜¶æ®µè¾“å‡ºä¸­çš„å­—æ®µåï¼ˆé»˜è®¤ä¸ param_name ç›¸åŒï¼‰
        allow_dynamic_resolution: æ˜¯å¦å¯¹ input_data ä¸­çš„å€¼è¿›è¡ŒåŠ¨æ€å¼•ç”¨è§£æï¼ˆé»˜è®¤ Trueï¼‰

    Returns:
        å‚æ•°å€¼æˆ–é»˜è®¤å€¼

    Examples:
        # åŸºæœ¬ç”¨æ³•
        >>> video_path = get_param_with_fallback("video_path", resolved_params, context)

        # ä»å‰ç½®èŠ‚ç‚¹å›é€€
        >>> subtitle_area = get_param_with_fallback(
        ...     "subtitle_area",
        ...     resolved_params,
        ...     context,
        ...     fallback_from_stage="paddleocr.detect_subtitle_area"
        ... )

        # å¸¦é»˜è®¤å€¼
        >>> batch_size = get_param_with_fallback(
        ...     "batch_size",
        ...     resolved_params,
        ...     context,
        ...     default=10
        ... )
    """
    # è½¬æ¢ WorkflowContext å¯¹è±¡ä¸ºå­—å…¸ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
    if isinstance(workflow_context, WorkflowContext):
        context_dict = workflow_context.model_dump()
    else:
        context_dict = workflow_context

    # 1. ä¼˜å…ˆä» resolved_params è·å–ï¼ˆnode_paramsï¼Œå·²è§£æï¼‰
    value = resolved_params.get(param_name)
    if value is not None:
        return value

    # 2. ä» input_data å›é€€ï¼ˆæ”¯æŒåŠ¨æ€å¼•ç”¨ï¼‰
    if fallback_from_input_data:
        input_data = context_dict.get("input_params", {}).get("input_data", {})
        value = input_data.get(param_name)

        if value is not None:
            # ğŸ”‘ å…³é”®ï¼šå¦‚æœå€¼æ˜¯å­—ç¬¦ä¸²ä¸”åŒ…å«åŠ¨æ€å¼•ç”¨ï¼Œåˆ™è§£æå®ƒ
            if allow_dynamic_resolution and isinstance(value, str):
                try:
                    resolved_value = _resolve_string(value, context_dict)
                    return resolved_value
                except ValueError:
                    # å¦‚æœè§£æå¤±è´¥ï¼ˆä¸æ˜¯æœ‰æ•ˆçš„åŠ¨æ€å¼•ç”¨ï¼‰ï¼Œè¿”å›åŸå€¼
                    return value
            return value

    # 3. ä»å‰ç½®é˜¶æ®µå›é€€ï¼ˆä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡ºï¼‰
    if fallback_from_stage:
        field = fallback_field or param_name
        stages = context_dict.get("stages", {})
        stage = stages.get(fallback_from_stage, {})

        if stage:
            output = stage.get("output", {})
            value = output.get(field)
            if value is not None:
                return value

    # 4. è¿”å›é»˜è®¤å€¼
    return default
```

### 3.3 ä½¿ç”¨ç¤ºä¾‹

#### ä¿®å¤å‰ï¼ˆæœ‰é—®é¢˜çš„ä»£ç ï¼‰ï¼š

```python
# å½“å‰ä»£ç  - ç¼ºå°‘ input_data å›é€€
video_path = resolved_params.get("video_path")
if not video_path:
    video_path = workflow_context.input_params.get("input_data", {}).get("video_path")

subtitle_area = resolved_params.get("subtitle_area")  # âŒ ç¼ºå°‘å›é€€
if not subtitle_area:
    prev_stage = workflow_context.stages.get('paddleocr.detect_subtitle_area')
    prev_stage_output = prev_stage.output if prev_stage else {}
    subtitle_area = prev_stage_output.get("subtitle_area")
```

#### ä¿®å¤åï¼ˆä½¿ç”¨æ–°å‡½æ•°ï¼‰ï¼š

```python
from services.common.parameter_resolver import resolve_parameters, get_param_with_fallback

# ç»Ÿä¸€çš„å‚æ•°è·å–
video_path = get_param_with_fallback("video_path", resolved_params, workflow_context)

subtitle_area = get_param_with_fallback(
    "subtitle_area",
    resolved_params,
    workflow_context,
    fallback_from_stage="paddleocr.detect_subtitle_area"
)

upload_to_minio = get_param_with_fallback(
    "upload_cropped_images_to_minio",
    resolved_params,
    workflow_context,
    default=False
)

decode_processes = get_param_with_fallback(
    "decode_processes",
    resolved_params,
    workflow_context,
    default=10
)
```

### 3.4 å•å…ƒæµ‹è¯•ä»£ç 

```python
# tests/unit/services/common/test_parameter_resolver.py

import pytest
from services.common.parameter_resolver import get_param_with_fallback
from services.common.context import WorkflowContext, StageExecution

def test_priority_resolved_params():
    """æµ‹è¯•ä¼˜å…ˆçº§1: resolved_params"""
    resolved_params = {"video_path": "/resolved/path.mp4"}
    context = {
        "input_params": {
            "input_data": {"video_path": "/input_data/path.mp4"}
        }
    }

    result = get_param_with_fallback("video_path", resolved_params, context)
    assert result == "/resolved/path.mp4"


def test_fallback_input_data():
    """æµ‹è¯•ä¼˜å…ˆçº§2: input_dataï¼ˆé™æ€å€¼ï¼‰"""
    resolved_params = {}
    context = {
        "input_params": {
            "input_data": {"subtitle_area": [0, 607, 1280, 679]}
        }
    }

    result = get_param_with_fallback("subtitle_area", resolved_params, context)
    assert result == [0, 607, 1280, 679]


def test_fallback_input_data_with_dynamic_reference():
    """æµ‹è¯•ä¼˜å…ˆçº§2: input_dataï¼ˆåŠ¨æ€å¼•ç”¨ï¼‰"""
    resolved_params = {}
    context = {
        "input_params": {
            "input_data": {
                "subtitle_area": "${{ stages.paddleocr.detect_subtitle_area.output.subtitle_area }}"
            }
        },
        "stages": {
            "paddleocr.detect_subtitle_area": {
                "output": {"subtitle_area": [0, 918, 1920, 1080]}
            }
        }
    }

    result = get_param_with_fallback("subtitle_area", resolved_params, context)
    assert result == [0, 918, 1920, 1080]


def test_fallback_from_stage():
    """æµ‹è¯•ä¼˜å…ˆçº§3: ä¸Šæ¸¸èŠ‚ç‚¹è¾“å‡º"""
    resolved_params = {}
    context = {
        "input_params": {"input_data": {}},
        "stages": {
            "paddleocr.detect_subtitle_area": {
                "output": {"subtitle_area": [0, 918, 1920, 1080]}
            }
        }
    }

    result = get_param_with_fallback(
        "subtitle_area",
        resolved_params,
        context,
        fallback_from_stage="paddleocr.detect_subtitle_area"
    )
    assert result == [0, 918, 1920, 1080]


def test_default_value():
    """æµ‹è¯•ä¼˜å…ˆçº§4: é»˜è®¤å€¼"""
    resolved_params = {}
    context = {"input_params": {"input_data": {}}, "stages": {}}

    result = get_param_with_fallback(
        "batch_size",
        resolved_params,
        context,
        default=10
    )
    assert result == 10


def test_with_workflow_context_object():
    """æµ‹è¯• WorkflowContext å¯¹è±¡å…¼å®¹æ€§"""
    resolved_params = {}
    context = WorkflowContext(
        workflow_id="test-123",
        input_params={
            "input_data": {"video_path": "/test/video.mp4"}
        },
        shared_storage_path="/share/test"
    )

    result = get_param_with_fallback("video_path", resolved_params, context)
    assert result == "/test/video.mp4"
```

---

## å››ã€åŠŸèƒ½èŠ‚ç‚¹æ£€æŸ¥æ¸…å•

### 4.1 FFmpegæœåŠ¡èŠ‚ç‚¹ï¼ˆ4ä¸ªï¼‰

| èŠ‚ç‚¹åç§° | æ–‡ä»¶ä½ç½® | å…³é”®å‚æ•° | å½“å‰å®ç° | é—®é¢˜è¯Šæ–­ | ä¿®å¤ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|---------|---------|---------|---------|----------|------|
| `ffmpeg.extract_keyframes` | tasks.py:40-149 | â€¢ video_path<br>â€¢ keyframe_sample_count<br>â€¢ upload_keyframes_to_minio<br>â€¢ delete_local_keyframes_after_upload | âœ… video_pathæœ‰å›é€€<br>âš ï¸ uploadå‚æ•°æ— å›é€€ | **ä¸­ç­‰** - uploadå‚æ•°ç¼ºå°‘input_dataå›é€€ | **P2** | âœ… å·²ä¿®å¤ |
| `ffmpeg.extract_audio` | tasks.py:151-229 | â€¢ video_path | âœ… video_pathæœ‰å›é€€ | **æ— é—®é¢˜** | - | âœ… æ— éœ€ä¿®å¤ |
| **`ffmpeg.crop_subtitle_images`** | tasks.py:273-429 | â€¢ video_path<br>â€¢ **subtitle_area**<br>â€¢ decode_processes<br>â€¢ upload_cropped_images_to_minio<br>â€¢ delete_local_cropped_images_after_upload | âœ… video_pathæœ‰å›é€€<br>âŒ **subtitle_areaæ— å›é€€**<br>âŒ decode_processesæ— å›é€€<br>âŒ uploadå‚æ•°æ— å›é€€ | **ğŸ”´ ä¸¥é‡** - å½“å‰æŠ¥é”™èŠ‚ç‚¹ | **P0** | âœ… å·²ä¿®å¤ |
| `ffmpeg.split_audio_segments` | tasks.py:431-631 | â€¢ audio_path<br>â€¢ subtitle_path<br>â€¢ å¤šä¸ªåˆ†å‰²å‚æ•° | âš ï¸ æœ‰æ™ºèƒ½æºé€‰æ‹©é€»è¾‘<br>ä½†æœªç”¨ç»Ÿä¸€å‡½æ•° | **ä½** - æœ‰è‡ªå®šä¹‰é€»è¾‘ï¼Œéœ€è¯„ä¼°æ˜¯å¦é‡æ„ | **P3** | âœ… å·²ä¿®å¤ |

### 4.2 Faster WhisperæœåŠ¡èŠ‚ç‚¹ï¼ˆ1ä¸ªï¼‰

| èŠ‚ç‚¹åç§° | æ–‡ä»¶ä½ç½® | å…³é”®å‚æ•° | å½“å‰å®ç° | é—®é¢˜è¯Šæ–­ | ä¿®å¤ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|---------|---------|---------|---------|----------|------|
| `faster_whisper.transcribe_audio` | tasks.py:30-539 | â€¢ audio_path | âœ… **æœ‰å®Œæ•´çš„input_dataå›é€€**<br>è¡Œ479-486å·²å®ç° | **âœ¨ æ— é—®é¢˜** - å®ç°æ­£ç¡® | - | âœ… æ— éœ€ä¿®å¤ |

### 4.3 Audio SeparatoræœåŠ¡èŠ‚ç‚¹ï¼ˆ1ä¸ªï¼‰

| èŠ‚ç‚¹åç§° | æ–‡ä»¶ä½ç½® | å…³é”®å‚æ•° | å½“å‰å®ç° | é—®é¢˜è¯Šæ–­ | ä¿®å¤ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|---------|---------|---------|---------|----------|------|
| `audio_separator.separate_vocals` | tasks.py:102-301 | â€¢ audio_path<br>â€¢ model_name<br>â€¢ quality_mode | âœ… **audio_pathæœ‰å®Œæ•´å›é€€**<br>åŒ…å«input_dataå›é€€ | **âœ¨ æ— é—®é¢˜** - æ­£ç¡®å®ç°ç¤ºä¾‹ | - | âœ… æ— éœ€ä¿®å¤ |

### 4.4 Pyannote AudioæœåŠ¡èŠ‚ç‚¹ï¼ˆ1ä¸ªï¼‰

| èŠ‚ç‚¹åç§° | æ–‡ä»¶ä½ç½® | å…³é”®å‚æ•° | å½“å‰å®ç° | é—®é¢˜è¯Šæ–­ | ä¿®å¤ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|---------|---------|---------|---------|----------|------|
| `pyannote_audio.diarize_speakers` | tasks.py:76-335 | â€¢ audio_path | âš ï¸ æœ‰æ™ºèƒ½éŸ³é¢‘æºé€‰æ‹©<br>ä½†åªä»ä¸Šæ¸¸èŠ‚ç‚¹è·å–<br>âŒ ç¼ºå°‘input_dataå›é€€ | **ä¸­ç­‰** - ç¼ºå°‘input_dataå›é€€é€»è¾‘ | **P2** | âœ… å·²ä¿®å¤ |

### 4.5 PaddleOCRæœåŠ¡èŠ‚ç‚¹ï¼ˆ4ä¸ªï¼‰

| èŠ‚ç‚¹åç§° | æ–‡ä»¶ä½ç½® | å…³é”®å‚æ•° | å½“å‰å®ç° | é—®é¢˜è¯Šæ–­ | ä¿®å¤ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|---------|---------|---------|---------|----------|------|
| `paddleocr.detect_subtitle_area` | tasks.py:125-420 | â€¢ keyframe_dir<br>â€¢ download_from_minio<br>â€¢ local_keyframe_dir | âš ï¸ æ··åˆå®ç°<br>éƒ¨åˆ†æœ‰å›é€€ | **ä¸­ç­‰** - éœ€è¦æ ‡å‡†åŒ– | **P2** | âœ… å·²ä¿®å¤ |
| `paddleocr.create_stitched_images` | tasks.py | â€¢ keyframe_dir<br>â€¢ subtitle_area<br>â€¢ output_root_dir | âœ… resolved_paramsæ”¯æŒ<br>âœ… ä¸Šæ¸¸èŠ‚ç‚¹å›é€€<br>âš ï¸ ç¼ºå°‘input_dataå›é€€ | **âœ¨ åŸºæœ¬æ­£ç¡®** - å¯é€‰ä¼˜åŒ– | **P3** | âœ… æ— éœ€ä¿®å¤ |
| `paddleocr.perform_ocr` | tasks.py | â€¢ manifest_path<br>â€¢ multi_frames_path | âœ… resolved_paramsæ”¯æŒ<br>âœ… ä¸Šæ¸¸èŠ‚ç‚¹å›é€€<br>âš ï¸ ç¼ºå°‘input_dataå›é€€ | **âœ¨ åŸºæœ¬æ­£ç¡®** - å¯é€‰ä¼˜åŒ– | **P3** | âœ… å·²ä¿®å¤ |
| `paddleocr.postprocess_and_finalize` | tasks.py | â€¢ ocr_results_path<br>â€¢ video_path | âœ… resolved_paramsæ”¯æŒ<br>âœ… ä¸Šæ¸¸èŠ‚ç‚¹å›é€€<br>âš ï¸ ç¼ºå°‘input_dataå›é€€ | **âœ¨ åŸºæœ¬æ­£ç¡®** - å¯é€‰ä¼˜åŒ– | **P3** | âœ… å·²ä¿®å¤ |

### 4.6 IndexTTSæœåŠ¡èŠ‚ç‚¹ï¼ˆ1ä¸ªï¼‰

| èŠ‚ç‚¹åç§° | æ–‡ä»¶ä½ç½® | å…³é”®å‚æ•° | å½“å‰å®ç° | é—®é¢˜è¯Šæ–­ | ä¿®å¤ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|---------|---------|---------|---------|----------|------|
| `indextts.generate_speech` | tasks.py | â€¢ text<br>â€¢ output_path<br>â€¢ spk_audio_prompt<br>â€¢ reference_audio<br>â€¢ emotion_reference | âœ… resolved_paramsæ”¯æŒ<br>âŒ **ç¼ºå°‘input_dataå›é€€**<br>âŒ **ç¼ºå°‘ä¸Šæ¸¸èŠ‚ç‚¹å›é€€** | **ğŸŸ¡ ä¸­ç­‰** - å…³é”®å‚æ•°ç¼ºå°‘å›é€€æœºåˆ¶ | **P2** | âœ… å·²ä¿®å¤ |

### 4.7 WServiceå­—å¹•ä¼˜åŒ–æœåŠ¡èŠ‚ç‚¹ï¼ˆ6ä¸ªï¼‰

| èŠ‚ç‚¹åç§° | æ–‡ä»¶ä½ç½® | å…³é”®å‚æ•° | å½“å‰å®ç° | é—®é¢˜è¯Šæ–­ | ä¿®å¤ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|---------|---------|---------|---------|----------|------|
| `wservice.generate_subtitle_files` | tasks.py | â€¢ segments<br>â€¢ audio_path<br>â€¢ speaker_segments | âœ… ä¸Šæ¸¸èŠ‚ç‚¹å›é€€<br>âš ï¸ ä¸ä¾èµ–resolved_params | **âœ¨ æ— é—®é¢˜** - è®¾è®¡åˆç† | - | âœ… æ— éœ€ä¿®å¤ |
| `wservice.correct_subtitles` | tasks.py | â€¢ subtitle_correction<br>â€¢ subtitle_path | âœ… resolved_paramsæ”¯æŒ<br>âœ… ä¸Šæ¸¸èŠ‚ç‚¹å›é€€<br>âš ï¸ éƒ¨åˆ†ç¼ºå°‘input_dataå›é€€ | **ä½** - é…ç½®ç±»å‚æ•°ï¼ŒåŸºæœ¬åˆç† | **P3** | âœ… å·²ä¿®å¤ |
| `wservice.ai_optimize_subtitles` | tasks.py | â€¢ subtitle_optimization<br>â€¢ segments_file<br>â€¢ provider | âœ… **å®Œå–„çš„å¤šå±‚å›é€€**<br>âœ… é˜²æ­¢å‚æ•°æ±¡æŸ“æœºåˆ¶ | **âœ¨ æ— é—®é¢˜** - æœ€ä½³å®è·µç¤ºä¾‹ | - | âœ… æ— éœ€ä¿®å¤ |
| `wservice.merge_speaker_segments` | tasks.py | â€¢ transcript_segments<br>â€¢ speaker_segments | âœ… ä¸Šæ¸¸èŠ‚ç‚¹å›é€€<br>âš ï¸ ä¸ä¾èµ–resolved_params | **âœ¨ æ— é—®é¢˜** - è®¾è®¡åˆç† | - | âœ… æ— éœ€ä¿®å¤ |
| `wservice.merge_with_word_timestamps` | tasks.py | â€¢ transcript_segments<br>â€¢ speaker_segments | âœ… ä¸Šæ¸¸èŠ‚ç‚¹å›é€€<br>âš ï¸ ä¸ä¾èµ–resolved_params | **âœ¨ æ— é—®é¢˜** - è®¾è®¡åˆç† | - | âœ… æ— éœ€ä¿®å¤ |
| `wservice.prepare_tts_segments` | tasks.py | â€¢ prepared_segments<br>â€¢ source_stage | âœ… ä¸Šæ¸¸èŠ‚ç‚¹å›é€€<br>âš ï¸ ä¸ä¾èµ–resolved_params | **âœ¨ æ— é—®é¢˜** - è®¾è®¡åˆç† | - | âœ… æ— éœ€ä¿®å¤ |

### 4.8 ç»Ÿè®¡æ±‡æ€»

| çŠ¶æ€ | æ•°é‡ | èŠ‚ç‚¹åˆ—è¡¨ |
|------|------|---------|
| âœ… **å®ç°æ­£ç¡®/å·²ä¿®å¤** | 14 | æ‰€æœ‰éœ€è¦ä¿®å¤çš„èŠ‚ç‚¹ |
| ğŸ“ **å¯é€‰ä¼˜åŒ–** | 0 | æ‰€æœ‰ä¼˜åŒ–é¡¹å‡å·²å®Œæˆ |
| ğŸ¯ **è®¾è®¡åˆç†** | 4 | æ— éœ€ä¿®æ”¹çš„çº¯åŠ å·¥èŠ‚ç‚¹ |
| **æ€»è®¡** | **18** | - |

---

## äº”ã€è¯¦ç»†æ–½å·¥TodoList

### Phase 1: åŸºç¡€è®¾æ–½å»ºè®¾ï¼ˆP0 - å¿…é¡»å®Œæˆï¼‰

#### âœ… Task 1.1: æ·»åŠ æ ¸å¿ƒå‡½æ•°
- **æ–‡ä»¶**: `services/common/parameter_resolver.py`
- **å†…å®¹**: æ·»åŠ  `get_param_with_fallback()` å‡½æ•°
- **ä»£ç è¡Œæ•°**: çº¦70è¡Œ
- **é¢„è®¡æ—¶é—´**: 30åˆ†é’Ÿ
- **ä¾èµ–**: æ— 
- **éªŒæ”¶æ ‡å‡†**: å‡½æ•°æ·»åŠ å®Œæˆï¼Œæ— è¯­æ³•é”™è¯¯
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### âœ… Task 1.2: ç¼–å†™å•å…ƒæµ‹è¯•
- **æ–‡ä»¶**: `tests/unit/services/common/test_parameter_resolver.py`
- **å†…å®¹**: ç¼–å†™6ä¸ªæµ‹è¯•ç”¨ä¾‹
  - `test_priority_resolved_params` - æµ‹è¯•ä¼˜å…ˆçº§1
  - `test_fallback_input_data` - æµ‹è¯•ä¼˜å…ˆçº§2ï¼ˆé™æ€å€¼ï¼‰
  - `test_fallback_input_data_with_dynamic_reference` - æµ‹è¯•ä¼˜å…ˆçº§2ï¼ˆåŠ¨æ€å¼•ç”¨ï¼‰
  - `test_fallback_from_stage` - æµ‹è¯•ä¼˜å…ˆçº§3
  - `test_default_value` - æµ‹è¯•ä¼˜å…ˆçº§4
  - `test_with_workflow_context_object` - æµ‹è¯•å¯¹è±¡å…¼å®¹æ€§
- **é¢„è®¡æ—¶é—´**: 45åˆ†é’Ÿ
- **ä¾èµ–**: Task 1.1
- **éªŒæ”¶æ ‡å‡†**: æ‰€æœ‰æµ‹è¯•é€šè¿‡
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### âœ… Task 1.3: è¿è¡Œæµ‹è¯•éªŒè¯
- **å‘½ä»¤**: `pytest tests/unit/services/common/test_parameter_resolver.py -v`
- **é¢„è®¡æ—¶é—´**: 10åˆ†é’Ÿ
- **ä¾èµ–**: Task 1.2
- **éªŒæ”¶æ ‡å‡†**: 100% æµ‹è¯•é€šè¿‡ç‡
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

### Phase 2: ç´§æ€¥ä¿®å¤ï¼ˆP0 - è§£å†³å½“å‰æŠ¥é”™ï¼‰

#### âœ… Task 2.1: ä¿®å¤ `ffmpeg.crop_subtitle_images`
- **æ–‡ä»¶**: `services/workers/ffmpeg_service/app/tasks.py` (ç¬¬273-429è¡Œ)
- **éœ€è¦ä¿®å¤çš„å‚æ•°**:
  1. `subtitle_area` - æ·»åŠ  input_data å›é€€å’Œä¸Šæ¸¸èŠ‚ç‚¹å›é€€
  2. `upload_cropped_images_to_minio` - æ·»åŠ  input_data å›é€€
  3. `delete_local_cropped_images_after_upload` - æ·»åŠ  input_data å›é€€
  4. `decode_processes` - æ·»åŠ  input_data å›é€€
- **é¢„è®¡æ—¶é—´**: 20åˆ†é’Ÿ
- **ä¾èµ–**: Task 1.1
- **éªŒæ”¶æ ‡å‡†**:
  - ä»£ç ä¿®æ”¹å®Œæˆ
  - ä½¿ç”¨ `get_param_with_fallback()` æ›¿æ¢ç°æœ‰å‚æ•°è·å–é€»è¾‘
  - ä¿æŒåŸæœ‰åŠŸèƒ½ä¸å˜
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### âœ… Task 2.2: æµ‹è¯•ä¿®å¤ç»“æœ
- **æµ‹è¯•æ–¹å¼**: ä½¿ç”¨ç”¨æˆ·æä¾›çš„n8nè¯·æ±‚
- **æµ‹è¯•ç”¨ä¾‹**:
  ```json
  {
    "task_name": "ffmpeg.crop_subtitle_images",
    "input_data": {
      "video_path": "http://minio:9000/yivideo/task_id/223.mp4",
      "subtitle_area": [0, 607, 1280, 679],
      "upload_cropped_images_to_minio": true
    }
  }
  ```
- **é¢„è®¡æ—¶é—´**: 15åˆ†é’Ÿ
- **ä¾èµ–**: Task 2.1
- **éªŒæ”¶æ ‡å‡†**:
  - ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ
  - ä¸å†æŠ¥ "ç¼ºå°‘å­—å¹•åŒºåŸŸåæ ‡ä¿¡æ¯" é”™è¯¯
  - åŠŸèƒ½æ­£å¸¸
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

### Phase 3: ä¸­ç­‰ä¼˜å…ˆçº§ä¿®å¤ï¼ˆP2ï¼‰

#### âœ… Task 3.1: ä¿®å¤ `ffmpeg.extract_keyframes`
- **æ–‡ä»¶**: `services/workers/ffmpeg_service/app/tasks.py` (ç¬¬40-149è¡Œ)
- **éœ€è¦ä¿®å¤çš„å‚æ•°**:
  - `upload_keyframes_to_minio`
  - `delete_local_keyframes_after_upload`
- **é¢„è®¡æ—¶é—´**: 10åˆ†é’Ÿ
- **ä¾èµ–**: Phase 1 å®Œæˆ
- **éªŒæ”¶æ ‡å‡†**: å‚æ•°è·å–ä½¿ç”¨ç»Ÿä¸€å‡½æ•°
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### ~~âš ï¸ Task 3.2: ä¿®å¤ `faster_whisper.transcribe_audio`~~ âœ… **å·²è·³è¿‡**
- **åŸå› **: ç»ä»£ç å®¡æ ¸å‘ç°ï¼Œè¯¥èŠ‚ç‚¹å·²æœ‰å®Œæ•´çš„ input_data å›é€€é€»è¾‘ï¼ˆè¡Œ479-486ï¼‰
- **çŠ¶æ€**: æ— éœ€ä¿®å¤
- **èŠ‚çœæ—¶é—´**: 15åˆ†é’Ÿ

#### âœ… Task 3.3: æ£€æŸ¥å¹¶ä¿®å¤ `paddleocr.detect_subtitle_area`
- **æ–‡ä»¶**: `services/workers/paddleocr_service/app/tasks.py` (ç¬¬125-420è¡Œ)
- **å†…å®¹**: æ ‡å‡†åŒ–å‚æ•°è·å–é€»è¾‘
- **é¢„è®¡æ—¶é—´**: 20åˆ†é’Ÿ
- **ä¾èµ–**: Phase 1 å®Œæˆ
- **éªŒæ”¶æ ‡å‡†**: ä½¿ç”¨ç»Ÿä¸€å‡½æ•°
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### âœ… Task 3.4: ä¿®å¤ `pyannote_audio.diarize_speakers`
- **æ–‡ä»¶**: `services/workers/pyannote_audio_service/app/tasks.py:76-335`
- **éœ€è¦ä¿®å¤çš„å‚æ•°**: `audio_path` - æ·»åŠ  input_data å›é€€é€»è¾‘
- **é¢„è®¡æ—¶é—´**: 15åˆ†é’Ÿ
- **ä¾èµ–**: Phase 1 å®Œæˆ
- **éªŒæ”¶æ ‡å‡†**: æ·»åŠ å®Œæ•´çš„å‚æ•°å›é€€æœºåˆ¶
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### âœ… Task 3.5: ä¿®å¤ `indextts.generate_speech`
- **æ–‡ä»¶**: `services/workers/indextts_service/app/tasks.py`
- **éœ€è¦ä¿®å¤çš„å‚æ•°**:
  - `text` - æ·»åŠ  input_data å’Œä¸Šæ¸¸èŠ‚ç‚¹å›é€€
  - `output_path` - æ·»åŠ  input_data å’Œä¸Šæ¸¸èŠ‚ç‚¹å›é€€
  - `spk_audio_prompt` - æ·»åŠ  input_data å’Œä¸Šæ¸¸èŠ‚ç‚¹å›é€€
  - `emo_audio_prompt` - æ·»åŠ  input_data å’Œä¸Šæ¸¸èŠ‚ç‚¹å›é€€
- **é¢„è®¡æ—¶é—´**: 20åˆ†é’Ÿ
- **ä¾èµ–**: Phase 1 å®Œæˆ
- **éªŒæ”¶æ ‡å‡†**: æ‰€æœ‰å…³é”®å‚æ•°éƒ½æœ‰å®Œæ•´çš„å›é€€æœºåˆ¶
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

### Phase 4: ä½ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆP3 - å¯é€‰ï¼‰

#### âœ… Task 4.1: ä¼˜åŒ– `ffmpeg.split_audio_segments`
- **æ–‡ä»¶**: `services/workers/ffmpeg_service/app/tasks.py:433-677`
- **ä¼˜åŒ–å†…å®¹**: è¯„ä¼°æ˜¯å¦éœ€è¦é‡æ„ç°æœ‰çš„æ™ºèƒ½æºé€‰æ‹©é€»è¾‘ä»¥ä½¿ç”¨ç»Ÿä¸€å‡½æ•°
- **é¢„è®¡æ—¶é—´**: 30åˆ†é’Ÿ
- **ä¾èµ–**: Phase 1 å®Œæˆ
- **éªŒæ”¶æ ‡å‡†**:
  - å†³ç­–æ–‡æ¡£ï¼šä¿æŒç°çŠ¶ or é‡æ„
  - å¦‚é‡æ„ï¼Œå®Œæˆä»£ç ä¿®æ”¹
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### âœ… Task 4.2: ä¼˜åŒ– `wservice.correct_subtitles`
- **æ–‡ä»¶**: `services/workers/wservice/app/tasks.py`
- **ä¼˜åŒ–å†…å®¹**: è¡¥å…… `subtitle_path` å‚æ•°çš„ input_data å›é€€é€»è¾‘
- **é¢„è®¡æ—¶é—´**: 15åˆ†é’Ÿ
- **ä¾èµ–**: Phase 1 å®Œæˆ
- **éªŒæ”¶æ ‡å‡†**: å®Œå–„å‚æ•°å›é€€æœºåˆ¶
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### âœ… Task 4.3: ä¼˜åŒ– `paddleocr.perform_ocr`
- **æ–‡ä»¶**: `services/workers/paddleocr_service/app/tasks.py`
- **ä¼˜åŒ–å†…å®¹**: æ ‡å‡†åŒ–å‚æ•°è·å–é€»è¾‘ï¼Œä½¿ç”¨ç»Ÿä¸€å‡½æ•°
- **é¢„è®¡æ—¶é—´**: 20åˆ†é’Ÿ
- **ä¾èµ–**: Phase 1 å®Œæˆ
- **éªŒæ”¶æ ‡å‡†**: å‚æ•°è·å–ä½¿ç”¨ç»Ÿä¸€å‡½æ•°
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### âœ… Task 4.4: ä¼˜åŒ– `paddleocr.postprocess_and_finalize`
- **æ–‡ä»¶**: `services/workers/paddleocr_service/app/tasks.py`
- **ä¼˜åŒ–å†…å®¹**: æ ‡å‡†åŒ–å‚æ•°è·å–é€»è¾‘ï¼Œä½¿ç”¨ç»Ÿä¸€å‡½æ•°
- **é¢„è®¡æ—¶é—´**: 20åˆ†é’Ÿ
- **ä¾èµ–**: Phase 1 å®Œæˆ
- **éªŒæ”¶æ ‡å‡†**: å‚æ•°è·å–ä½¿ç”¨ç»Ÿä¸€å‡½æ•°
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

### Phase 5: æ–‡æ¡£å’ŒéªŒè¯

#### âœ… Task 5.1: æ›´æ–°æŠ€æœ¯æ–‡æ¡£
- **æ–‡ä»¶**: `docs/technical/reference/WORKFLOW_NODES_REFERENCE.md`
- **å†…å®¹**:
  - æ·»åŠ "å‚æ•°è·å–æœºåˆ¶"ç« èŠ‚
  - è¯´æ˜ç»Ÿä¸€å‚æ•°è·å–å‡½æ•°çš„ä½¿ç”¨
  - æ›´æ–°å„èŠ‚ç‚¹çš„å‚æ•°è¯´æ˜
- **é¢„è®¡æ—¶é—´**: 20åˆ†é’Ÿ
- **ä¾èµ–**: Phase 2-4 å®Œæˆ
- **éªŒæ”¶æ ‡å‡†**: æ–‡æ¡£æ›´æ–°å®Œæ•´
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### âœ… Task 5.2: ç¼–å†™è¿ç§»æŒ‡å—
- **æ–‡ä»¶**: `docs/technical/å‚æ•°è·å–å‡½æ•°è¿ç§»æŒ‡å—.md`
- **å†…å®¹**:
  - æ–°å‡½æ•°ä½¿ç”¨è¯´æ˜
  - è¿ç§»æ­¥éª¤
  - æœ€ä½³å®è·µ
  - å¸¸è§é—®é¢˜
- **é¢„è®¡æ—¶é—´**: 30åˆ†é’Ÿ
- **ä¾èµ–**: Phase 2-4 å®Œæˆ
- **éªŒæ”¶æ ‡å‡†**: æŒ‡å—æ–‡æ¡£æ¸…æ™°å®Œæ•´
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

#### âœ… Task 5.3: ç«¯åˆ°ç«¯æµ‹è¯•
- **æµ‹è¯•åœºæ™¯**:
  - å·¥ä½œæµæ¨¡å¼æµ‹è¯•
  - å•ä»»åŠ¡æ¨¡å¼æµ‹è¯•ï¼ˆé™æ€å‚æ•°ï¼‰
  - å•ä»»åŠ¡æ¨¡å¼æµ‹è¯•ï¼ˆåŠ¨æ€å¼•ç”¨ï¼‰
  - ä¸Šæ¸¸èŠ‚ç‚¹è‡ªåŠ¨è·å–æµ‹è¯•
- **é¢„è®¡æ—¶é—´**: 45åˆ†é’Ÿ
- **ä¾èµ–**: Phase 2-4 å®Œæˆ
- **éªŒæ”¶æ ‡å‡†**: æ‰€æœ‰åœºæ™¯æµ‹è¯•é€šè¿‡
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## å…­ã€é£é™©è¯„ä¼°ä¸ç¼“è§£

### 6.1 é£é™©çŸ©é˜µ

| é£é™© | ç­‰çº§ | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|------|---------|
| æ–°å‡½æ•°å¼•å…¥bug | ğŸŸ¡ ä¸­ | å½±å“å¤šä¸ªèŠ‚ç‚¹ | ä½ | â€¢ å®Œå–„çš„å•å…ƒæµ‹è¯•è¦†ç›–<br>â€¢ ä»£ç å®¡æŸ¥<br>â€¢ æ¸è¿›å¼éƒ¨ç½² |
| ç ´åç°æœ‰æ­£å¸¸èŠ‚ç‚¹ | ğŸŸ¢ ä½ | éƒ¨åˆ†åŠŸèƒ½å¤±æ•ˆ | ä½ | â€¢ ä»…ä¿®å¤æœ‰é—®é¢˜çš„èŠ‚ç‚¹<br>â€¢ ä¿å®ˆç­–ç•¥<br>â€¢ å……åˆ†æµ‹è¯• |
| é—æ¼æŸäº›èŠ‚ç‚¹ | ğŸŸ¡ ä¸­ | é—®é¢˜æŒç»­å­˜åœ¨ | ä¸­ | â€¢ è¯¦ç»†çš„æ£€æŸ¥è¡¨æ ¼<br>â€¢ ä»£ç æœç´¢éªŒè¯<br>â€¢ æ–‡æ¡£è®°å½• |
| æ€§èƒ½å½±å“ | ğŸŸ¢ ä½ | å“åº”å˜æ…¢ | æä½ | â€¢ å‡½æ•°è®¾è®¡ç®€æ´<br>â€¢ æ— é¢å¤–å¼€é”€<br>â€¢ æ€§èƒ½æµ‹è¯• |
| åŠ¨æ€å¼•ç”¨è§£æå¤±è´¥ | ğŸŸ¡ ä¸­ | å‚æ•°è·å–å¤±è´¥ | ä½ | â€¢ å¼‚å¸¸å¤„ç†æœºåˆ¶<br>â€¢ é™çº§åˆ°åŸå€¼<br>â€¢ æ—¥å¿—è®°å½• |

### 6.2 å›æ»šè®¡åˆ’

å¦‚æœä¿®å¤åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. **Gitå›æ»š**: `git revert <commit-hash>`
2. **çƒ­ä¿®å¤**: é’ˆå¯¹é—®é¢˜èŠ‚ç‚¹å•ç‹¬ä¿®å¤
3. **é™çº§ç­–ç•¥**: æš‚æ—¶ç¦ç”¨æœ‰é—®é¢˜çš„èŠ‚ç‚¹

---

## ä¸ƒã€æ—¶é—´é¢„ä¼°

### 7.1 æŒ‰é˜¶æ®µç»Ÿè®¡

| é˜¶æ®µ | ä»»åŠ¡æ•° | é¢„è®¡æ—¶é—´ | å…³é”®é‡Œç¨‹ç¢‘ |
|------|-------|---------|----------|
| **Phase 1** - åŸºç¡€è®¾æ–½ | 3 | 1.5å°æ—¶ | æ ¸å¿ƒå‡½æ•°å®Œæˆ |
| **Phase 2** - ç´§æ€¥ä¿®å¤ | 2 | 0.5å°æ—¶ | ç”Ÿäº§bugä¿®å¤ |
| **Phase 3** - ä¸­ç­‰ä¼˜å…ˆçº§ | 4 | 1.0å°æ—¶ | ä¸»è¦èŠ‚ç‚¹ä¿®å¤ï¼ˆè·³è¿‡faster_whisperï¼‰ |
| **Phase 4** - ä½ä¼˜å…ˆçº§ | 4 | 1.5å°æ—¶ | å¯é€‰ä¼˜åŒ–å®Œæˆ |
| **Phase 5** - æ–‡æ¡£éªŒè¯ | 3 | 1.5å°æ—¶ | æ–‡æ¡£å®Œå–„ |
| **æ€»è®¡** | **16** | **6.0å°æ—¶** | - |

### 7.2 å…³é”®è·¯å¾„

```
Phase 1 (å¿…é¡») â†’ Phase 2 (ç´§æ€¥) â†’ Phase 5 (éªŒè¯) = 3.5å°æ—¶ï¼ˆæœ€å°å®Œæˆæ—¶é—´ï¼‰
```

### 7.3 å»ºè®®å®æ–½é¡ºåº

#### ğŸš€ ç¬¬ä¸€æ‰¹ï¼ˆç´§æ€¥ï¼‰- é¢„è®¡2å°æ—¶
1. Phase 1: åŸºç¡€è®¾æ–½å»ºè®¾ï¼ˆ1.5å°æ—¶ï¼‰
2. Phase 2: ä¿®å¤å½“å‰æŠ¥é”™ï¼ˆ0.5å°æ—¶ï¼‰

#### ğŸ“Š ç¬¬äºŒæ‰¹ï¼ˆé‡è¦ï¼‰- é¢„è®¡1.0å°æ—¶
3. Phase 3: ä¸­ç­‰ä¼˜å…ˆçº§ä¿®å¤ï¼ˆ4ä¸ªèŠ‚ç‚¹ï¼Œè·³è¿‡faster_whisperï¼‰

#### ğŸ“ ç¬¬ä¸‰æ‰¹ï¼ˆå®Œå–„ï¼‰- é¢„è®¡3å°æ—¶
4. Phase 4: ä½ä¼˜å…ˆçº§ä¼˜åŒ–
5. Phase 5: æ–‡æ¡£å’ŒéªŒè¯

---

## å…«ã€éªŒæ”¶æ ‡å‡†

### 8.1 åŠŸèƒ½éªŒæ”¶

- [x] æ–°å‡½æ•° `get_param_with_fallback()` æ·»åŠ å®Œæˆ
- [x] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆ100%ï¼‰
- [x] `ffmpeg.crop_subtitle_images` ä¿®å¤å®Œæˆï¼Œç”¨æˆ·æŠ¥é”™é—®é¢˜è§£å†³
- [x] P2ä¼˜å…ˆçº§èŠ‚ç‚¹ä¿®å¤å®Œæˆï¼ˆ4ä¸ªèŠ‚ç‚¹ï¼Œè·³è¿‡faster_whisperï¼‰
- [x] ç«¯åˆ°ç«¯æµ‹è¯•å…¨éƒ¨é€šè¿‡

### 8.2 è´¨é‡éªŒæ”¶

- [x] ä»£ç ç¬¦åˆé¡¹ç›®ç¼–ç è§„èŒƒ
- [x] æ‰€æœ‰ä¿®æ”¹éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹
- [x] æ–‡æ¡£æ›´æ–°å®Œæ•´
- [x] æ— æ–°å¢çš„ä»£ç å‘Šè­¦

### 8.3 æ€§èƒ½éªŒæ”¶

- [x] å‚æ•°è·å–æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™
- [x] å†…å­˜å ç”¨æ— æ˜æ˜¾å¢åŠ 
- [x] æ— æ€§èƒ½å›å½’

---

## ä¹ã€é™„å½•

### 9.1 å‚è€ƒæ–‡æ¡£

- [å·¥ä½œæµèŠ‚ç‚¹å‚è€ƒæ–‡æ¡£](./reference/WORKFLOW_NODES_REFERENCE.md)
- [Commonæ¨¡å—æ–‡æ¡£](../services/common/CLAUDE.md)
- [å‚æ•°è§£æå™¨æºç ](../../services/common/parameter_resolver.py)

### 9.2 ç›¸å…³Issue

- å½“å‰ç”Ÿäº§bugï¼š`ffmpeg.crop_subtitle_images` å‚æ•°è¯»å–å¤±è´¥

### 9.3 å˜æ›´å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 2025-11-22 | v1.0 | åˆå§‹ç‰ˆæœ¬ | Claude |
| 2025-11-22 | v1.1 | å®¡æ ¸ä¿®æ­£ï¼šfaster_whisper.transcribe_audioå·²æ­£ç¡®å®ç°ï¼Œä»ä¿®å¤åˆ—è¡¨ç§»é™¤ | Claude |
| 2025-11-22 | v1.2 | æ›´æ–°æ‰§è¡ŒçŠ¶æ€ï¼Œæ ‡è®°å·²å®Œæˆçš„ä»»åŠ¡ | Gemini |
| 2025-11-22 | v1.3 | æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ ‡è®°ä¸º Final | Gemini |

---

## åã€å®¡æ ¸ç­¾å­—

| è§’è‰² | å§“å | ç­¾å­— | æ—¥æœŸ |
|------|------|------|------|
| æŠ€æœ¯æ–¹æ¡ˆåˆ¶å®š | Claude | âœ… | 2025-11-22 |
| æŠ€æœ¯å®¡æ ¸ | Claude | âœ… é€šè¿‡ | 2025-11-22 |
| å®æ–½è´Ÿè´£äºº | Gemini | âœ… å·²å®Œæˆ | 2025-11-22 |

---

**ğŸ“Œ ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
1. âœ… å®¡æ ¸æœ¬æ–½å·¥æ–¹æ¡ˆï¼ˆå·²å®Œæˆï¼‰
2. âœ… æ ¹æ®å®¡æ ¸ç»“æœä¿®æ­£æ–‡æ¡£ï¼ˆå·²å®Œæˆï¼‰
3. âœ… ç¡®è®¤åå¼€å§‹å®æ–½ Phase 1
4. âœ… å®Œæˆç´§æ€¥ä¿®å¤ Phase 2
5. âœ… å®Œæˆä¸­ä¼˜å…ˆçº§ä¿®å¤ Phase 3
6. âœ… å®Œæˆä½ä¼˜å…ˆçº§ä¼˜åŒ– Phase 4
7. âœ… ç¼–å†™è¿ç§»æŒ‡å— (Phase 5.2)
8. âœ… æ›´æ–°æ–¹æ¡ˆæ–‡æ¡£çŠ¶æ€ (Final)

